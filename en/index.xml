<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Ryan&#39;s Janky Website</title>
        <link>https://yearsuns-github-io.vercel.app/en/</link>
        <description>Recent content on Ryan&#39;s Janky Website</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-US</language>
        <copyright>Yearsuns</copyright>
        <lastBuildDate>Sat, 20 Sep 2025 14:59:56 +0800</lastBuildDate><atom:link href="https://yearsuns-github-io.vercel.app/en/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Best Practices for Gas Optimization in Solidity</title>
        <link>https://yearsuns-github-io.vercel.app/en/p/best-practices-for-gas-optimization-in-solidity/</link>
        <pubDate>Sat, 20 Sep 2025 14:59:56 +0800</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/p/best-practices-for-gas-optimization-in-solidity/</guid>
        <description>&lt;h2 id=&#34;1-why-gas-optimization-matters&#34;&gt;1. Why Gas Optimization Matters
&lt;/h2&gt;&lt;p&gt;When developing smart contracts on Ethereum, Gas is an unavoidable concept.
It is neither merely a “transaction fee” nor just a temporary cost caused by network congestion. Instead, it represents a &lt;strong&gt;long-term constraint on contract design quality&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Many developers start paying attention to Gas only after encountering situations such as:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Exceptionally high deployment costs&lt;/li&gt;
&lt;li&gt;Frequent “Out of Gas” errors when users call certain functions&lt;/li&gt;
&lt;li&gt;Significant cost differences between different implementations of the same functionality&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These issues usually do not stem from business logic mistakes, but rather from a &lt;strong&gt;lack of intuition about the EVM cost model&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;11-the-two-meanings-of-gas&#34;&gt;1.1 The Two Meanings of Gas
&lt;/h3&gt;&lt;p&gt;Before discussing optimization, it is important to distinguish two commonly confused concepts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;gas used&lt;/strong&gt;: the number of Gas units actually consumed when executing a transaction&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;gas price&lt;/strong&gt;: the price you are willing to pay per unit of Gas&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Contract code can only affect &lt;strong&gt;gas used&lt;/strong&gt;, not gas price.&lt;/p&gt;
&lt;p&gt;This means:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Network congestion increases gas price, but does not change a contract’s gas usage&lt;/li&gt;
&lt;li&gt;A poorly designed contract is expensive under any network conditions&lt;/li&gt;
&lt;li&gt;When gas price is high, inefficiencies in contract design become even more costly&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Therefore, Gas optimization is not about “betting on network conditions,” but about &lt;strong&gt;minimizing the number of Gas units consumed per execution&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;12-why-functionally-correct-does-not-mean-cost-efficient&#34;&gt;1.2 Why “Functionally Correct” Does Not Mean “Cost-Efficient”
&lt;/h3&gt;&lt;p&gt;In traditional software development, as long as the program works correctly, performance issues can often be optimized later.
In smart contracts, however, &lt;strong&gt;performance is cost&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Even a contract that:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Has no security vulnerabilities&lt;/li&gt;
&lt;li&gt;Implements the intended functionality correctly&lt;/li&gt;
&lt;li&gt;Passes all tests&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;can still become impractical because:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Certain functions are too expensive to execute on-chain&lt;/li&gt;
&lt;li&gt;Transaction failure rates increase during peak periods&lt;/li&gt;
&lt;li&gt;Users pay unnecessary costs for the same functionality over time&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These problems are rarely caused by “wrong code,” but by &lt;strong&gt;ignoring structural Gas costs at the design stage&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;13-the-goals-of-gas-optimization&#34;&gt;1.3 The Goals of Gas Optimization
&lt;/h3&gt;&lt;p&gt;Gas optimization is not about achieving the absolute lowest cost, but about serving three practical goals:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Reducing long-term usage costs&lt;/strong&gt;
For frequently called functions, saving even a few hundred Gas can add up significantly over time.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Improving transaction success rates&lt;/strong&gt;
More predictable Gas usage reduces the risk of running out of Gas in complex execution paths.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Improving cost predictability&lt;/strong&gt;
Making it easier for callers to estimate required Gas and reducing uncertainty.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This is why Gas optimization should usually focus on:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;High-frequency execution paths&lt;/li&gt;
&lt;li&gt;Core business logic&lt;/li&gt;
&lt;li&gt;Functions where users directly pay execution costs&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;14-when-not-to-over-optimize&#34;&gt;1.4 When Not to Over-Optimize
&lt;/h3&gt;&lt;p&gt;It is important to recognize that &lt;strong&gt;Gas optimization has diminishing returns&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;The following are usually not worth doing:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Introducing complex and obscure code to save a trivial amount of Gas&lt;/li&gt;
&lt;li&gt;Applying heavy micro-optimizations to low-frequency or cold paths&lt;/li&gt;
&lt;li&gt;Sacrificing safety checks or readability for marginal gains&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A reasonable principle is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Write safe, clear, and maintainable code first, then optimize only where it truly matters.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In most cases, understanding and avoiding high-cost structures is more valuable than memorizing isolated tricks.&lt;/p&gt;
&lt;h3 id=&#34;15-what-comes-next&#34;&gt;1.5 What Comes Next
&lt;/h3&gt;&lt;p&gt;The following sections start from the fundamentals:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;What the EVM actually charges Gas for&lt;/li&gt;
&lt;li&gt;Which instructions are expensive and which are almost negligible&lt;/li&gt;
&lt;li&gt;Why storage access is the core driver of Gas costs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Once you understand these principles, later optimization practices will feel natural rather than rule-based.&lt;/p&gt;
&lt;h2 id=&#34;2-the-gas-cost-model&#34;&gt;2. The Gas Cost Model
&lt;/h2&gt;&lt;p&gt;Before diving into specific optimization techniques, it is essential to build a clear cost intuition: &lt;strong&gt;not all EVM operations cost the same&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Many Solidity constructs that appear “simple” consume large amounts of Gas because they trigger expensive low-level instructions.&lt;/p&gt;
&lt;p&gt;The goal of this section is simple:
&lt;strong&gt;Know which operations should be avoided or minimized, and which can be largely ignored.&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;21-instruction-level-pricing&#34;&gt;2.1 Instruction-Level Pricing
&lt;/h3&gt;&lt;p&gt;The EVM is a stack-based virtual machine. Solidity code is compiled into a sequence of EVM opcodes such as:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Arithmetic and comparison instructions like &lt;code&gt;ADD&lt;/code&gt;, &lt;code&gt;SUB&lt;/code&gt;, &lt;code&gt;LT&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Memory operations like &lt;code&gt;MLOAD&lt;/code&gt;, &lt;code&gt;MSTORE&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Storage operations like &lt;code&gt;SLOAD&lt;/code&gt;, &lt;code&gt;SSTORE&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;External calls like &lt;code&gt;CALL&lt;/code&gt;, &lt;code&gt;DELEGATECALL&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Gas is charged entirely at the instruction level&lt;/strong&gt;, not at the Solidity syntax level. This means:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A single line of Solidity can compile into multiple opcodes&lt;/li&gt;
&lt;li&gt;Different-looking code can compile into very different instruction sequences&lt;/li&gt;
&lt;li&gt;Gas differences come from instruction types and counts, not from code length&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In essence, Gas optimization means one thing:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Execute expensive instructions fewer times.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;22-cost-tiers&#34;&gt;2.2 Cost Tiers
&lt;/h3&gt;&lt;p&gt;From a cost perspective, EVM operations can be roughly grouped (from cheapest to most expensive):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pure computation (arithmetic, comparisons, bitwise operations)&lt;/li&gt;
&lt;li&gt;Memory reads and writes&lt;/li&gt;
&lt;li&gt;Calldata reads&lt;/li&gt;
&lt;li&gt;Storage reads (&lt;code&gt;SLOAD&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Storage writes (&lt;code&gt;SSTORE&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;External calls and large data returns&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The key takeaway is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Storage operations are far more expensive than most computations.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This is why so many Gas optimizations ultimately converge on the same goal:
&lt;strong&gt;reducing storage access.&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;23-what-storage-is-and-why-it-is-expensive&#34;&gt;2.3 What Storage Is and Why It Is Expensive
&lt;/h3&gt;&lt;p&gt;In Solidity, all state variables are stored in &lt;strong&gt;storage&lt;/strong&gt;.
From the EVM’s perspective, storage is a massive key–value store:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Key: storage slot index&lt;/li&gt;
&lt;li&gt;Value: 32 bytes of data&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Storage has several defining characteristics:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Data is persistent&lt;/li&gt;
&lt;li&gt;It affects the global state trie&lt;/li&gt;
&lt;li&gt;All full nodes must agree on its contents&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Every storage write modifies the global state, which is the fundamental reason storage operations are so costly.&lt;/p&gt;
&lt;h3 id=&#34;24-the-real-cost-of-reading-storage&#34;&gt;2.4 The Real Cost of Reading Storage
&lt;/h3&gt;&lt;p&gt;When you read a state variable, for example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; count;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;the key instruction is &lt;code&gt;SLOAD&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Since EIP-2929, &lt;code&gt;SLOAD&lt;/code&gt; has two cost modes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Cold access&lt;/strong&gt;: the first access to a storage slot in a transaction&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Warm access&lt;/strong&gt;: subsequent accesses to the same slot in the same transaction&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Intuitively:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The first read “brings the value in”&lt;/li&gt;
&lt;li&gt;Subsequent reads are cheaper, but still far more expensive than memory or computation&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Even warm &lt;code&gt;SLOAD&lt;/code&gt; is significantly more expensive than arithmetic or memory access.&lt;/p&gt;
&lt;h3 id=&#34;25-why-writing-storage-is-among-the-most-expensive-operations&#34;&gt;2.5 Why Writing Storage Is Among the Most Expensive Operations
&lt;/h3&gt;&lt;p&gt;When you modify a state variable, such as:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;count &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; count &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;this is not a simple increment, but a full read–modify–write sequence:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;SLOAD&lt;/code&gt; – read the old value&lt;/li&gt;
&lt;li&gt;Perform the addition&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SSTORE&lt;/code&gt; – write the new value&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The cost of &lt;code&gt;SSTORE&lt;/code&gt; depends on the state transition:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Zero → non-zero: most expensive&lt;/li&gt;
&lt;li&gt;Non-zero → non-zero: less expensive&lt;/li&gt;
&lt;li&gt;Non-zero → zero: cheaper and may trigger a refund&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These rules are designed to encourage contracts to free unused storage.&lt;/p&gt;
&lt;h3 id=&#34;26-what-a-single-line-of-solidity-really-does&#34;&gt;2.6 What a Single Line of Solidity Really Does
&lt;/h3&gt;&lt;p&gt;Consider this common statement:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;count &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;From Solidity’s perspective, it is trivial.
From the EVM’s perspective, it usually means:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;One &lt;code&gt;SLOAD&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;One arithmetic instruction&lt;/li&gt;
&lt;li&gt;One &lt;code&gt;SSTORE&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you repeat it in the same function:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;count &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;count &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;count &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;you are not performing three additions, but triggering:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;3 &lt;code&gt;SLOAD&lt;/code&gt;s&lt;/li&gt;
&lt;li&gt;3 &lt;code&gt;SSTORE&lt;/code&gt;s&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is how Gas costs escalate quickly.&lt;/p&gt;
&lt;h3 id=&#34;27-a-key-intuition&#34;&gt;2.7 A Key Intuition
&lt;/h3&gt;&lt;p&gt;At this point, a crucial intuition should be clear:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Arithmetic and logic are rarely the bottleneck&lt;/li&gt;
&lt;li&gt;Storage reads and writes dominate Gas costs&lt;/li&gt;
&lt;li&gt;Repeated access to the same storage slot is one of the most common and overlooked sources of waste&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Once this intuition is established, later optimizations—caching, write merging, storage packing—will feel obvious rather than magical.&lt;/p&gt;
&lt;h2 id=&#34;3-reducing-storage-reads-and-writes&#34;&gt;3. Reducing Storage Reads and Writes
&lt;/h2&gt;&lt;p&gt;After understanding the EVM cost model, the priority of Gas optimization becomes very clear:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Any reduction in storage access almost certainly leads to significant Gas savings.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Most Gas optimization techniques revolve around a single core objective:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Make &lt;code&gt;SLOAD&lt;/code&gt; and &lt;code&gt;SSTORE&lt;/code&gt; execute as few times as possible.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;31-why-storage-optimization-has-the-highest-roi&#34;&gt;3.1 Why Storage Optimization Has the Highest ROI
&lt;/h3&gt;&lt;p&gt;As discussed earlier:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Arithmetic operations are very cheap&lt;/li&gt;
&lt;li&gt;Memory operations are moderately priced&lt;/li&gt;
&lt;li&gt;Storage writes are among the most expensive operations&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This implies:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Eliminating a single &lt;code&gt;SSTORE&lt;/code&gt; is often more valuable than optimizing dozens of arithmetic instructions&lt;/li&gt;
&lt;li&gt;Optimizing storage access typically yields order-of-magnitude improvements&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In practice, Gas optimization should follow this order:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;First, reduce storage reads and writes&lt;/li&gt;
&lt;li&gt;Then consider secondary optimizations such as loops, parameters, and bit-level tricks&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;32-caching-repeated-reads-turning-multiple-sloads-into-one&#34;&gt;3.2 Caching Repeated Reads: Turning Multiple &lt;code&gt;SLOAD&lt;/code&gt;s into One
&lt;/h3&gt;&lt;p&gt;One of the most common and easily overlooked inefficiencies is reading the same state variable multiple times within a function.&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;increment&lt;/span&gt;() &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    require(count &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; max, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;too large&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    count &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; count &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    emit Updated(count);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this code, &lt;code&gt;count&lt;/code&gt; is actually read multiple times:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Once in the &lt;code&gt;require&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Once during the increment&lt;/li&gt;
&lt;li&gt;Once again when emitting the event&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A more efficient version caches it in a local variable:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;increment&lt;/span&gt;() &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; c &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; count;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    require(c &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; max, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;too large&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    c &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; c &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    count &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; c;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    emit Updated(c);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The result is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Storage is read only once&lt;/li&gt;
&lt;li&gt;Storage is written only once&lt;/li&gt;
&lt;li&gt;All intermediate operations happen in memory&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This change barely affects readability, yet can significantly reduce Gas usage.&lt;/p&gt;
&lt;h3 id=&#34;33-merging-writes-avoiding-repeated-sstores&#34;&gt;3.3 Merging Writes: Avoiding Repeated &lt;code&gt;SSTORE&lt;/code&gt;s
&lt;/h3&gt;&lt;p&gt;Another common issue is writing to the same storage variable multiple times within a single function.&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;update&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; x) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    value &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; x;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (x &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; threshold) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        value &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; bonus;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Although the logic is clear, this code may trigger multiple &lt;code&gt;SSTORE&lt;/code&gt;s on &lt;code&gt;value&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;A better approach is to perform all calculations in memory first:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;update&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; x) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; v &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; value;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    v &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; x;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (x &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; threshold) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        v &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; bonus;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    value &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; v;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The guiding principle is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Do not repeatedly write to storage inside conditional logic—compute first, then write back once.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;34-storage-pitfalls-inside-loops&#34;&gt;3.4 Storage Pitfalls Inside Loops
&lt;/h3&gt;&lt;p&gt;Loops are where storage inefficiencies are most easily amplified.&lt;/p&gt;
&lt;p&gt;Consider the following implementation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata arr) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; arr.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        total &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; arr[i];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this loop:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;total&lt;/code&gt; is read and written on every iteration&lt;/li&gt;
&lt;li&gt;For an array of length &lt;code&gt;n&lt;/code&gt;, this triggers &lt;code&gt;n&lt;/code&gt; &lt;code&gt;SLOAD&lt;/code&gt;s and &lt;code&gt;n&lt;/code&gt; &lt;code&gt;SSTORE&lt;/code&gt;s&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A more efficient version is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata arr) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; t &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; total;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; len &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; arr.length;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; len; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        t &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; arr[i];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    total &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; t;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This small change has an impact that grows linearly with the array length.&lt;/p&gt;
&lt;h3 id=&#34;35-design-principles-for-avoiding-storage-writes-in-loops&#34;&gt;3.5 Design Principles for Avoiding Storage Writes in Loops
&lt;/h3&gt;&lt;p&gt;When designing contracts, try to avoid patterns like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Writing to storage inside unbounded loops&lt;/li&gt;
&lt;li&gt;Updating state on every iteration&lt;/li&gt;
&lt;li&gt;Letting loop bounds be fully controlled by external input&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Better alternatives include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Computing results in memory and committing once&lt;/li&gt;
&lt;li&gt;Designing batch interfaces with strict per-call limits&lt;/li&gt;
&lt;li&gt;Moving complex computation off-chain and only verifying results on-chain&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These are not mere “coding tricks,” but &lt;strong&gt;structural design decisions that should be made early&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;36-using-mappings-instead-of-arrays&#34;&gt;3.6 Using Mappings Instead of Arrays
&lt;/h3&gt;&lt;p&gt;In contracts, the choice between arrays and mappings is not just a style preference—it reflects a fundamental cost model difference:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Array operations like search, deduplication, or deletion often require traversal, with &lt;strong&gt;O(n)&lt;/strong&gt; cost and unbounded loops&lt;/li&gt;
&lt;li&gt;Mapping access is direct by key, close to &lt;strong&gt;O(1)&lt;/strong&gt;, making it more predictable and Gas-efficient&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;case-1-membership-checks-contains&#34;&gt;Case 1: Membership Checks (contains)
&lt;/h4&gt;&lt;p&gt;Not recommended: storing members in an array and searching on-chain&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; members;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;isMember&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; a) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;view&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;returns&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; members.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (members[i] &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; a) &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Problems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Requires traversal on every check&lt;/li&gt;
&lt;li&gt;Cost grows with the number of members&lt;/li&gt;
&lt;li&gt;Worst case can run out of Gas&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Recommended: use a mapping for existence checks&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;mapping&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt;) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; isMember;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addMember&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; a) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    isMember[a] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;removeMember&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; a) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    isMember[a] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Advantages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;O(1) existence checks&lt;/li&gt;
&lt;li&gt;Predictable cost&lt;/li&gt;
&lt;li&gt;No loops required&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;case-2-enumerable-sets-o1-checks--enumeration&#34;&gt;Case 2: Enumerable Sets (O(1) checks + enumeration)
&lt;/h4&gt;&lt;p&gt;Some applications require both:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;O(1) membership checks&lt;/li&gt;
&lt;li&gt;Enumeration of all members (e.g., for frontends)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A common pattern is &lt;strong&gt;mapping + array&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;mapping&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt;) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; isMember;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; memberList;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;mapping&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;) &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; indexPlusOne; &lt;span style=&#34;color:#75715e&#34;&gt;// index + 1, 0 means absent
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addMember&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; a) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (indexPlusOne[a] &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;) &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    isMember[a] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    memberList.push(a);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    indexPlusOne[a] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; memberList.length;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;removeMember&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; a) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; idxPlusOne &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; indexPlusOne[a];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (idxPlusOne &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;) &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; idx &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; idxPlusOne &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; last &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; memberList.length &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (idx &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; last) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; lastAddr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; memberList[last];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        memberList[idx] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; lastAddr;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        indexPlusOne[lastAddr] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; idx &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    memberList.pop();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    indexPlusOne[a] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    isMember[a] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Explanation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The mapping handles O(1) checks and indexing&lt;/li&gt;
&lt;li&gt;The array handles enumeration&lt;/li&gt;
&lt;li&gt;Deletion uses swap-and-pop to avoid O(n) shifts&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;This introduces extra storage (index mapping)&lt;/li&gt;
&lt;li&gt;In exchange, operation cost becomes predictable and bounded—usually well worth it&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;when-arrays-are-the-wrong-choice&#34;&gt;When Arrays Are the Wrong Choice
&lt;/h4&gt;&lt;p&gt;If you find yourself doing any of the following with arrays, consider switching to mappings:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Membership checks&lt;/li&gt;
&lt;li&gt;Deduplication&lt;/li&gt;
&lt;li&gt;Deleting arbitrary elements&lt;/li&gt;
&lt;li&gt;Preventing duplicate inserts&lt;/li&gt;
&lt;li&gt;Any traversal driven by unbounded user input&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In short:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Arrays are for ordered data and index-based access. Mappings are for lookup, deduplication, and existence checks. When searching or deleting is involved, mappings are usually cheaper and safer.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;4-data-location-and-function-interface-design&#34;&gt;4. Data Location and Function Interface Design
&lt;/h2&gt;&lt;p&gt;After reducing unnecessary storage access, the next category of high–value optimizations lies in &lt;strong&gt;function interface design&lt;/strong&gt;, especially:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Parameter data locations&lt;/li&gt;
&lt;li&gt;Function visibility&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These choices usually do not affect business logic, but they directly influence:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Whether unnecessary data copying occurs&lt;/li&gt;
&lt;li&gt;Whether extra ABI encoding/decoding is triggered&lt;/li&gt;
&lt;li&gt;Which execution path the EVM takes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Well-designed interfaces often provide &lt;strong&gt;low-risk, high-return&lt;/strong&gt; Gas optimizations.&lt;/p&gt;
&lt;h3 id=&#34;41-cost-intuition-for-data-locations&#34;&gt;4.1 Cost Intuition for Data Locations
&lt;/h3&gt;&lt;p&gt;In Solidity, reference types (arrays, structs, strings, bytes) must explicitly or implicitly specify a data location:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;calldata&lt;/strong&gt;: read-only, located in call data&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;memory&lt;/strong&gt;: read–write, exists during function execution&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;storage&lt;/strong&gt;: persistent, stored on-chain&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;From a cost perspective, a simple intuition applies:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reading calldata: cheap&lt;/li&gt;
&lt;li&gt;Reading/writing memory: moderate&lt;/li&gt;
&lt;li&gt;Reading/writing storage: expensive&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A fundamental rule follows:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Prefer calldata over memory, and memory over storage whenever possible.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;42-external-functions-and-calldata&#34;&gt;4.2 &lt;code&gt;external&lt;/code&gt; Functions and &lt;code&gt;calldata&lt;/code&gt;
&lt;/h3&gt;&lt;p&gt;For functions that are only called externally, the recommended pattern is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;process&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata data) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// use data
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Parameters of &lt;code&gt;external&lt;/code&gt; functions naturally live in calldata&lt;/li&gt;
&lt;li&gt;No need to copy data into memory&lt;/li&gt;
&lt;li&gt;For large arrays or complex structs, the savings can be substantial&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;By contrast:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;process&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt; data) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// use data
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Even if &lt;code&gt;data&lt;/code&gt; is not modified, the compiler must:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Copy the entire calldata payload into memory&lt;/li&gt;
&lt;li&gt;Pay the additional Gas cost for that copy&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;43-when-memory-is-required&#34;&gt;4.3 When &lt;code&gt;memory&lt;/code&gt; Is Required
&lt;/h3&gt;&lt;p&gt;The limitation of calldata is clear: &lt;strong&gt;it is read-only&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;If a function needs to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Modify array contents&lt;/li&gt;
&lt;li&gt;Sort&lt;/li&gt;
&lt;li&gt;Deduplicate&lt;/li&gt;
&lt;li&gt;Dynamically construct new arrays&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;then &lt;code&gt;memory&lt;/code&gt; is required.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;normalize&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata data)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;returns&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt; result &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[](data.length);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; data.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        result[i] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; data[i] &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; result;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Key points:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Input parameters use calldata to avoid copying&lt;/li&gt;
&lt;li&gt;Output uses memory because it must be writable&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is a very common and sensible pattern.&lt;/p&gt;
&lt;h3 id=&#34;44-gas-implications-of-function-visibility&#34;&gt;4.4 Gas Implications of Function Visibility
&lt;/h3&gt;&lt;p&gt;Function visibility affects not only accessibility, but also Gas cost.&lt;/p&gt;
&lt;p&gt;A useful intuition:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;external&lt;/strong&gt;: reads parameters directly from calldata, cheapest&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;public&lt;/strong&gt;: parameters are copied into memory, more expensive&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;internal&lt;/strong&gt;: often inlined or called via jump, very cheap&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;private&lt;/strong&gt;: similar to internal, but limited to the contract&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;An important conclusion:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;public&lt;/code&gt; is not a universally optimal “inside-and-outside” choice.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;45-external-entry--internal-implementation&#34;&gt;4.5 External Entry + Internal Implementation
&lt;/h3&gt;&lt;p&gt;A highly recommended pattern in real projects is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Expose &lt;code&gt;external&lt;/code&gt; functions&lt;/li&gt;
&lt;li&gt;Move core logic into &lt;code&gt;internal&lt;/code&gt; functions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;update&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; x) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    _update(x);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;_update&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; x) &lt;span style=&#34;color:#66d9ef&#34;&gt;internal&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// core logic
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;External calls use calldata with minimal copying&lt;/li&gt;
&lt;li&gt;Internal calls are extremely cheap&lt;/li&gt;
&lt;li&gt;One shared implementation for both internal and external usage&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This pattern has almost no downsides and avoids many hidden Gas costs.&lt;/p&gt;
&lt;h3 id=&#34;46-why-you-should-avoid-calling-this&#34;&gt;4.6 Why You Should Avoid Calling &lt;code&gt;this&lt;/code&gt;
&lt;/h3&gt;&lt;p&gt;A subtle but expensive anti-pattern is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;this.update(x);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Even if &lt;code&gt;update&lt;/code&gt; is defined in the same contract, this triggers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A full external call&lt;/li&gt;
&lt;li&gt;ABI encoding and decoding&lt;/li&gt;
&lt;li&gt;A &lt;code&gt;CALL&lt;/code&gt; opcode execution&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Consequences:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Higher Gas cost&lt;/li&gt;
&lt;li&gt;More complex execution path&lt;/li&gt;
&lt;li&gt;Potential reentrancy risks&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you find yourself using &lt;code&gt;this.foo()&lt;/code&gt;, it usually means:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Logic is poorly structured&lt;/li&gt;
&lt;li&gt;Internal abstraction is insufficient&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The correct refactor is to extract logic into an internal function and call it directly.&lt;/p&gt;
&lt;h3 id=&#34;47-a-comparison-example&#34;&gt;4.7 A Comparison Example
&lt;/h3&gt;&lt;p&gt;Less efficient approach:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;foo&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt; data) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// use data
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bar&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt; data) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    foo(data);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Recommended approach:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;foo&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata data) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    _foo(data);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;bar&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata data) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    _foo(data);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;_foo&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata data) &lt;span style=&#34;color:#66d9ef&#34;&gt;internal&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// use data
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Why the second approach is better:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Avoids repeated parameter copying&lt;/li&gt;
&lt;li&gt;Centralizes logic&lt;/li&gt;
&lt;li&gt;Uses cheaper internal calls&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;5-state-layout-design-storage-packing&#34;&gt;5. State Layout Design: Storage Packing
&lt;/h2&gt;&lt;p&gt;So far, most optimizations have focused on &lt;em&gt;how&lt;/em&gt; state variables are accessed.
This section addresses a more structural question:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;How state variables are laid out in storage.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;A significant amount of Gas waste comes not from frequent access, but from &lt;strong&gt;inefficient state layout&lt;/strong&gt;, leading to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;More storage slots than necessary&lt;/li&gt;
&lt;li&gt;Extra &lt;code&gt;SLOAD&lt;/code&gt; / &lt;code&gt;SSTORE&lt;/code&gt; operations&lt;/li&gt;
&lt;li&gt;Amplified long-term costs&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;51-storage-slots-and-32-byte-alignment&#34;&gt;5.1 Storage Slots and 32-Byte Alignment
&lt;/h3&gt;&lt;p&gt;From the EVM’s perspective, storage is organized in &lt;strong&gt;32-byte (256-bit) slots&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Solidity places state variables into slots in declaration order:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Variables smaller than 32 bytes may share a slot&lt;/li&gt;
&lt;li&gt;If remaining space is insufficient, a new slot is used&lt;/li&gt;
&lt;li&gt;Once a slot is full, no more variables are packed into it&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This mechanism is known as &lt;strong&gt;storage packing&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;52-a-basic-packing-example&#34;&gt;5.2 A Basic Packing Example
&lt;/h3&gt;&lt;p&gt;Consider:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint128&lt;/span&gt; a;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint128&lt;/span&gt; b;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; c;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Each &lt;code&gt;uint128&lt;/code&gt; uses 16 bytes, so &lt;code&gt;a&lt;/code&gt; and &lt;code&gt;b&lt;/code&gt; share one slot.
&lt;code&gt;c&lt;/code&gt; occupies its own slot.
Total: &lt;strong&gt;2 slots&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Now change the order:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint128&lt;/span&gt; a;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; c;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint128&lt;/span&gt; b;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Result:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;a&lt;/code&gt; uses the first 16 bytes of slot 0&lt;/li&gt;
&lt;li&gt;&lt;code&gt;c&lt;/code&gt; occupies slot 1 entirely&lt;/li&gt;
&lt;li&gt;&lt;code&gt;b&lt;/code&gt; cannot fit in slot 0 and goes to slot 2&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Total: &lt;strong&gt;3 slots&lt;/strong&gt;—one extra slot used purely due to ordering.&lt;/p&gt;
&lt;h3 id=&#34;53-why-slot-count-directly-affects-gas&#34;&gt;5.3 Why Slot Count Directly Affects Gas
&lt;/h3&gt;&lt;p&gt;Every additional storage slot increases long-term cost:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;More slots read → more &lt;code&gt;SLOAD&lt;/code&gt;s&lt;/li&gt;
&lt;li&gt;More slots written → more &lt;code&gt;SSTORE&lt;/code&gt;s&lt;/li&gt;
&lt;li&gt;Higher cost when copying or updating structs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is especially important in:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;High-frequency functions&lt;/li&gt;
&lt;li&gt;Struct-heavy designs&lt;/li&gt;
&lt;li&gt;Long-lived contracts&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;54-smaller-types-are-not-always-cheaper&#34;&gt;5.4 Smaller Types Are Not Always Cheaper
&lt;/h3&gt;&lt;p&gt;Important caveat:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Using types smaller than 256 bits does &lt;strong&gt;not&lt;/strong&gt; automatically save Gas&lt;/li&gt;
&lt;li&gt;Savings only occur if packing actually happens&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint128&lt;/span&gt; a;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; b;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Even though &lt;code&gt;a&lt;/code&gt; is smaller, it still occupies its own slot because &lt;code&gt;b&lt;/code&gt; follows it.&lt;/p&gt;
&lt;p&gt;Type choice and declaration order must be considered together.&lt;/p&gt;
&lt;h3 id=&#34;55-when-storage-packing-is-worth-the-effort&#34;&gt;5.5 When Storage Packing Is Worth the Effort
&lt;/h3&gt;&lt;p&gt;Not every contract needs aggressive packing.&lt;/p&gt;
&lt;p&gt;Storage packing is most valuable when:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;There are many state variables&lt;/li&gt;
&lt;li&gt;Structs are used extensively&lt;/li&gt;
&lt;li&gt;State is frequently read and written&lt;/li&gt;
&lt;li&gt;The contract has a long operational lifetime&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For small, rarely-used contracts, the benefit may be marginal.&lt;/p&gt;
&lt;h2 id=&#34;6-loops-and-batch-processing&#34;&gt;6. Loops and Batch Processing
&lt;/h2&gt;&lt;p&gt;From the previous sections, one pattern should already be clear:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Storage access is expensive&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Loops amplify that cost linearly&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Loops themselves are not inherently bad, but &lt;strong&gt;unbounded or poorly designed loops almost always become a Gas problem&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;61-why-loops-easily-become-gas-black-holes&#34;&gt;6.1 Why Loops Easily Become Gas Black Holes
&lt;/h3&gt;&lt;p&gt;From the EVM’s perspective, a loop is nothing special—it simply:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Repeats a sequence of instructions&lt;/li&gt;
&lt;li&gt;Pays the full instruction cost on every iteration&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If the loop body contains:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Storage reads or writes&lt;/li&gt;
&lt;li&gt;Expensive computations&lt;/li&gt;
&lt;li&gt;External calls&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;then Gas usage grows linearly with the iteration count.&lt;/p&gt;
&lt;p&gt;The risk becomes severe when the loop length is controlled by external input.&lt;/p&gt;
&lt;h3 id=&#34;62-caching-array-length-and-intermediate-results&#34;&gt;6.2 Caching Array Length and Intermediate Results
&lt;/h3&gt;&lt;p&gt;A very common and basic optimization is caching an array’s length.&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata arr) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; arr.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        s &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; arr[i];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Although &lt;code&gt;arr.length&lt;/code&gt; looks trivial, it is re-read on every loop condition check.&lt;/p&gt;
&lt;p&gt;A better version is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata arr) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; len &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; arr.length;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; len; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        s &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; arr[i];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This optimization saves little Gas per iteration, but the difference becomes noticeable in large arrays or high-frequency calls.&lt;/p&gt;
&lt;h3 id=&#34;63-avoid-writing-to-storage-inside-loops&#34;&gt;6.3 Avoid Writing to Storage Inside Loops
&lt;/h3&gt;&lt;p&gt;As emphasized earlier, writing to storage inside loops is extremely expensive.&lt;/p&gt;
&lt;p&gt;The principle can be summarized as:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Do calculations inside loops, but commit results to storage only once, outside the loop.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;64-using-unchecked-safely&#34;&gt;6.4 Using &lt;code&gt;unchecked&lt;/code&gt; Safely
&lt;/h3&gt;&lt;p&gt;Since Solidity 0.8, integer arithmetic includes overflow checks by default.
This is valuable for safety, but it also introduces extra Gas cost.&lt;/p&gt;
&lt;p&gt;A typical example is a loop counter:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; len; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If you can guarantee that:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;i&lt;/code&gt; will never approach &lt;code&gt;type(uint256).max&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;The loop has a strict upper bound&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;then you can use:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; len; ) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;unchecked&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The Gas savings are smaller than storage optimizations, but still measurable in large loops.&lt;/p&gt;
&lt;h3 id=&#34;65-avoid-unbounded-loops&#34;&gt;6.5 Avoid Unbounded Loops
&lt;/h3&gt;&lt;p&gt;When designing contract interfaces, try to avoid:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Loop bounds fully controlled by user input&lt;/li&gt;
&lt;li&gt;Loops without explicit upper limits&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;process&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata items) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; items.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If &lt;code&gt;items.length&lt;/code&gt; is unrestricted, callers can pass extremely large arrays, causing:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Transaction failure due to Out of Gas&lt;/li&gt;
&lt;li&gt;Practical unavailability of the function&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Common improvements include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Enforcing a maximum length&lt;/li&gt;
&lt;li&gt;Splitting work across multiple transactions&lt;/li&gt;
&lt;li&gt;Providing paginated or cursor-based APIs&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;66-trade-offs-in-batch-design&#34;&gt;6.6 Trade-offs in Batch Design
&lt;/h3&gt;&lt;p&gt;Batch processing is often used to reduce transaction count and amortize fixed costs, but it is not free.&lt;/p&gt;
&lt;p&gt;Advantages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Fewer external calls&lt;/li&gt;
&lt;li&gt;Amortized function entry and validation cost&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Risks:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Unpredictable per-transaction Gas usage&lt;/li&gt;
&lt;li&gt;Higher likelihood of Out of Gas&lt;/li&gt;
&lt;li&gt;Harder Gas estimation&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Therefore, batch interfaces should usually provide:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A clear per-call upper bound&lt;/li&gt;
&lt;li&gt;Predictable worst-case cost&lt;/li&gt;
&lt;li&gt;Well-defined failure behavior&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;67-a-batch-processing-example&#34;&gt;6.7 A Batch Processing Example
&lt;/h3&gt;&lt;p&gt;Not recommended:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;batchUpdate&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata ids) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; ids.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        update(ids[i]);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Improved version:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;constant&lt;/span&gt; MAX_BATCH &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;batchUpdate&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata ids) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; len &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ids.length;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    require(len &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;=&lt;/span&gt; MAX_BATCH, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;too many items&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; len; ) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        _update(ids[i]);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;unchecked&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The key improvement is not raw Gas savings, but:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Controlled cost&lt;/li&gt;
&lt;li&gt;Predictable behavior&lt;/li&gt;
&lt;li&gt;A more user-friendly interface&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;7-error-handling-and-bytecode-size-optimization&#34;&gt;7. Error Handling and Bytecode Size Optimization
&lt;/h2&gt;&lt;p&gt;Gas optimization discussions often focus on the “successful execution path,” while overlooking &lt;strong&gt;failure paths and contract bytecode size&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;In reality, error handling affects not only revert-time Gas usage, but also:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Deployment cost&lt;/li&gt;
&lt;li&gt;Baseline execution cost&lt;/li&gt;
&lt;li&gt;Bytecode size and maintainability&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This section focuses on a practical and consistently beneficial optimization:
&lt;strong&gt;efficient error handling and reverts&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;71-reverts-are-not-free&#34;&gt;7.1 Reverts Are Not Free
&lt;/h3&gt;&lt;p&gt;When a transaction reverts, state changes are rolled back—but Gas is not fully refunded.&lt;/p&gt;
&lt;p&gt;Costs that still apply include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Gas consumed by executed instructions&lt;/li&gt;
&lt;li&gt;Data returned with the revert&lt;/li&gt;
&lt;li&gt;ABI encoding overhead&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Therefore, frequently triggered validation logic deserves careful cost consideration, even on failure paths.&lt;/p&gt;
&lt;h3 id=&#34;72-the-real-cost-of-requirestring&#34;&gt;7.2 The Real Cost of &lt;code&gt;require(string)&lt;/code&gt;
&lt;/h3&gt;&lt;p&gt;The traditional error-handling pattern is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;require(msg.sender &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; owner, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Not owner&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The problem is not correctness, but cost:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The string literal is embedded in bytecode&lt;/li&gt;
&lt;li&gt;Each revert returns the string data&lt;/li&gt;
&lt;li&gt;Longer strings increase deployment and revert costs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In large contracts, extensive use of &lt;code&gt;require(string)&lt;/code&gt; significantly increases bytecode size.&lt;/p&gt;
&lt;h3 id=&#34;73-motivation-for-custom-errors&#34;&gt;7.3 Motivation for Custom Errors
&lt;/h3&gt;&lt;p&gt;Solidity 0.8.4 introduced &lt;strong&gt;custom errors&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;error NotOwner();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Used as:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (msg.sender &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; owner) revert NotOwner();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Advantages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;No embedded strings&lt;/li&gt;
&lt;li&gt;Error identifiers encoded as selectors&lt;/li&gt;
&lt;li&gt;Much smaller revert payloads&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;From a cost perspective, this reduces:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Deployment Gas&lt;/li&gt;
&lt;li&gt;Revert-path Gas&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;74-comparison-example&#34;&gt;7.4 Comparison Example
&lt;/h3&gt;&lt;p&gt;Using &lt;code&gt;require(string)&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;withdraw&lt;/span&gt;() &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    require(msg.sender &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; owner, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Not owner&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Using a custom error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;error NotOwner();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;withdraw&lt;/span&gt;() &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (msg.sender &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; owner) revert NotOwner();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Gas usage on the success path is nearly identical, but differences appear in:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Contract size&lt;/li&gt;
&lt;li&gt;Revert Gas cost&lt;/li&gt;
&lt;li&gt;Error encoding efficiency&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These differences accumulate in complex or high-frequency contracts.&lt;/p&gt;
&lt;h3 id=&#34;75-how-detailed-should-error-messages-be&#34;&gt;7.5 How Detailed Should Error Messages Be?
&lt;/h3&gt;&lt;p&gt;A common misconception is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;More detailed error messages are always better.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;From an on-chain perspective, this is often untrue.&lt;/p&gt;
&lt;p&gt;A better division of responsibility is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;On-chain: concise, structured error identifiers&lt;/li&gt;
&lt;li&gt;Off-chain: documentation or mapping tables explaining errors&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Custom errors fit this model well because they are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Structured&lt;/li&gt;
&lt;li&gt;Parameterizable&lt;/li&gt;
&lt;li&gt;Easy for frontends and SDKs to decode&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;error InsufficientBalance(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; available, &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; required);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;76-why-bytecode-size-matters&#34;&gt;7.6 Why Bytecode Size Matters
&lt;/h3&gt;&lt;p&gt;Contract bytecode size directly affects:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Deployment cost&lt;/li&gt;
&lt;li&gt;Deployment success (there is a size limit)&lt;/li&gt;
&lt;li&gt;Baseline execution cost (larger code costs more to load)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The following increase bytecode size:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Large numbers of string literals&lt;/li&gt;
&lt;li&gt;Repeated logic branches&lt;/li&gt;
&lt;li&gt;Verbose error messages&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Gas optimization is therefore not only about runtime execution, but also &lt;strong&gt;deployment-time efficiency&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;77-balancing-error-handling-and-readability&#34;&gt;7.7 Balancing Error Handling and Readability
&lt;/h3&gt;&lt;p&gt;It is important to stress:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Custom errors are not about extreme compression&lt;/li&gt;
&lt;li&gt;They do not require sacrificing readability&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A reasonable approach is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Use custom errors for public-facing core interfaces&lt;/li&gt;
&lt;li&gt;Use &lt;code&gt;require&lt;/code&gt; selectively for internal assertions or development checks&lt;/li&gt;
&lt;li&gt;Avoid embedding long textual descriptions in bytecode&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;8-event-and-return-value-design&#34;&gt;8. Event and Return Value Design
&lt;/h2&gt;&lt;p&gt;In smart contracts, &lt;strong&gt;events&lt;/strong&gt; and &lt;strong&gt;function return values&lt;/strong&gt; are commonly used to expose information externally.
However, if designed poorly, they can easily become &lt;strong&gt;hidden sources of Gas consumption&lt;/strong&gt;, especially in high-frequency or data-heavy scenarios.&lt;/p&gt;
&lt;p&gt;The core idea of this section can be summarized as:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Blockchains are good at state verification, not data querying.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Understanding this helps you make more economical design choices for events and return values.&lt;/p&gt;
&lt;h3 id=&#34;81-the-role-boundary-of-events&#34;&gt;8.1 The Role Boundary of Events
&lt;/h3&gt;&lt;p&gt;The primary purposes of events are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Allowing off-chain systems to listen and index&lt;/li&gt;
&lt;li&gt;Recording important state changes&lt;/li&gt;
&lt;li&gt;Supporting auditing and analysis&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Events are &lt;strong&gt;not readable on-chain&lt;/strong&gt; and do not affect subsequent execution logic.
From an execution perspective, events are “write once, off-chain only” data.&lt;/p&gt;
&lt;p&gt;This leads to a key design principle:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Events should serve off-chain consumers, not replace on-chain state queries.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;82-gas-cost-composition-of-events&#34;&gt;8.2 Gas Cost Composition of Events
&lt;/h3&gt;&lt;p&gt;The Gas cost of an event consists of two parts:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Topics&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The event signature&lt;/li&gt;
&lt;li&gt;Up to three &lt;code&gt;indexed&lt;/code&gt; parameters&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Data&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Non-indexed parameters&lt;/li&gt;
&lt;li&gt;Charged by byte size&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Intuitively:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;indexed&lt;/code&gt; parameters improve filterability&lt;/li&gt;
&lt;li&gt;But they are not free&lt;/li&gt;
&lt;li&gt;Larger data payloads cost more Gas&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Event design therefore requires a trade-off between &lt;strong&gt;queryability&lt;/strong&gt; and &lt;strong&gt;cost&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;83-proper-use-of-indexed&#34;&gt;8.3 Proper Use of &lt;code&gt;indexed&lt;/code&gt;
&lt;/h3&gt;&lt;p&gt;Consider a typical transfer event:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;event&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Transfer&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;indexed&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;indexed&lt;/span&gt; to, &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; amount);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This design makes sense because:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;from&lt;/code&gt; and &lt;code&gt;to&lt;/code&gt; are common filter fields&lt;/li&gt;
&lt;li&gt;&lt;code&gt;amount&lt;/code&gt; is rarely used as a filter&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But if written as:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;event&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Transfer&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;indexed&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;indexed&lt;/span&gt; to,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;indexed&lt;/span&gt; amount
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Query power barely improves&lt;/li&gt;
&lt;li&gt;Gas cost increases&lt;/li&gt;
&lt;li&gt;You quickly hit the three-index limit&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A practical rule of thumb:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Only mark fields as &lt;code&gt;indexed&lt;/code&gt; if they are frequently used for filtering.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;84-avoid-carrying-large-data-in-events&#34;&gt;8.4 Avoid Carrying Large Data in Events
&lt;/h3&gt;&lt;p&gt;A common but expensive pattern is emitting large data structures:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;event&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;DataUpdated&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] values);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Problems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Entire arrays are written to logs&lt;/li&gt;
&lt;li&gt;Gas cost grows linearly with data size&lt;/li&gt;
&lt;li&gt;Both on-chain execution and off-chain storage become expensive&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Better alternatives include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Emitting only identifiers, hashes, or counters&lt;/li&gt;
&lt;li&gt;Storing full data off-chain&lt;/li&gt;
&lt;li&gt;Linking via hashes or IDs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;event&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;DataUpdated&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;bytes32&lt;/span&gt; dataHash);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;85-avoid-returning-large-arrays-on-chain&#34;&gt;8.5 Avoid Returning Large Arrays On-Chain
&lt;/h3&gt;&lt;p&gt;Solidity allows functions to return arrays or structs:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;getUsers&lt;/span&gt;() &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;view&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;returns&lt;/span&gt; (User[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;While intuitive, this design is not cheap.&lt;/p&gt;
&lt;h4 id=&#34;what-happens-in-on-chain-calls&#34;&gt;What Happens in On-Chain Calls
&lt;/h4&gt;&lt;p&gt;If this function is called &lt;strong&gt;by another contract&lt;/strong&gt;, even as a &lt;code&gt;view&lt;/code&gt; function, it still consumes Gas.
The EVM must:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Read all &lt;code&gt;User&lt;/code&gt; entries from storage&lt;/li&gt;
&lt;li&gt;Copy them into memory&lt;/li&gt;
&lt;li&gt;ABI-encode the entire array&lt;/li&gt;
&lt;li&gt;Return the encoded bytes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;All of these costs scale linearly with array size—&lt;strong&gt;with no upper bound&lt;/strong&gt;.&lt;/p&gt;
&lt;h4 id=&#34;why-this-is-often-unnecessary&#34;&gt;Why This Is Often Unnecessary
&lt;/h4&gt;&lt;p&gt;In real-world projects, full data lists are usually:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Needed by frontends or backend services&lt;/li&gt;
&lt;li&gt;Used for display, analytics, or reporting&lt;/li&gt;
&lt;li&gt;Not relied upon by other contracts&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Off-chain systems can retrieve such data for free using &lt;code&gt;eth_call&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This creates a common inefficiency:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;On-chain callers pay Gas for data&lt;/li&gt;
&lt;li&gt;The actual consumers are off-chain&lt;/li&gt;
&lt;li&gt;Off-chain consumers could have read the data at zero cost&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;a-better-design-approach&#34;&gt;A Better Design Approach
&lt;/h4&gt;&lt;p&gt;Function return values should distinguish between:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;On-chain callable functions&lt;/strong&gt;
Keep return values minimal or return nothing&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Off-chain query functions&lt;/strong&gt;
Returning arrays or structs is acceptable, but intended for &lt;code&gt;eth_call&lt;/code&gt; only&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If on-chain access is required, pagination or cursor-based APIs are safer.&lt;/p&gt;
&lt;h3 id=&#34;86-pagination-and-cursor-based-access&#34;&gt;8.6 Pagination and Cursor-Based Access
&lt;/h3&gt;&lt;p&gt;For large datasets, pagination is usually preferable:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;getUsers&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; offset, &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; limit)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;view&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;returns&lt;/span&gt; (User[] &lt;span style=&#34;color:#66d9ef&#34;&gt;memory&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// return a slice
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Bounded Gas usage for on-chain calls&lt;/li&gt;
&lt;li&gt;Efficient off-chain iteration&lt;/li&gt;
&lt;li&gt;Predictable interface behavior&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;87-event-design-comparison-example&#34;&gt;8.7 Event Design Comparison Example
&lt;/h3&gt;&lt;p&gt;Not recommended:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;event&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;OrderCreated&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; user,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] itemIds,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] prices
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Improved version:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;event&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;OrderCreated&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;indexed&lt;/span&gt; user,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;bytes32&lt;/span&gt; orderId
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;With off-chain systems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Resolving full order data via &lt;code&gt;orderId&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Treating events as index signals, not data containers&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This design is far more scalable and cost-effective.&lt;/p&gt;
&lt;h2 id=&#34;9-compact-representation-and-low-level-optimizations-use-with-caution&#34;&gt;9. Compact Representation and Low-Level Optimizations (Use with Caution)
&lt;/h2&gt;&lt;p&gt;So far, most optimizations discussed share common traits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;No major readability loss&lt;/li&gt;
&lt;li&gt;Controlled risk&lt;/li&gt;
&lt;li&gt;Stable, predictable gains&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This section covers &lt;strong&gt;advanced techniques&lt;/strong&gt; that can save Gas, but also introduce:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reduced readability&lt;/li&gt;
&lt;li&gt;Higher implementation complexity&lt;/li&gt;
&lt;li&gt;Increased audit and maintenance costs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The goal here is not to advocate their use, but to answer:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Which low-level optimizations are worth using, and under what conditions.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;91-bit-operations-and-bitmaps&#34;&gt;9.1 Bit Operations and Bitmaps
&lt;/h3&gt;&lt;p&gt;A common and relatively safe advanced technique is the &lt;strong&gt;bitmap&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Suppose you need to track many boolean states:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Whether an address completed a step&lt;/li&gt;
&lt;li&gt;Whether an ID is used&lt;/li&gt;
&lt;li&gt;A fixed-size set of flags&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The straightforward approach:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;mapping&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt;) used;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This is clear, but each &lt;code&gt;bool&lt;/code&gt; consumes an entire storage slot.&lt;/p&gt;
&lt;h4 id=&#34;bitmap-approach&#34;&gt;Bitmap Approach
&lt;/h4&gt;&lt;p&gt;If the keys are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Sequential&lt;/li&gt;
&lt;li&gt;Bounded&lt;/li&gt;
&lt;li&gt;Numerous&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;you can pack 256 boolean values into one &lt;code&gt;uint256&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; bitmap;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;isUsed&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; index) &lt;span style=&#34;color:#66d9ef&#34;&gt;internal&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;view&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;returns&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; (bitmap &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; index)) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setUsed&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; index) &lt;span style=&#34;color:#66d9ef&#34;&gt;internal&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    bitmap &lt;span style=&#34;color:#f92672&#34;&gt;|=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; index);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;One slot stores 256 flags&lt;/li&gt;
&lt;li&gt;Far fewer storage reads/writes&lt;/li&gt;
&lt;li&gt;Significant Gas savings in high-frequency scenarios&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;92-when-bitmaps-make-sense&#34;&gt;9.2 When Bitmaps Make Sense
&lt;/h3&gt;&lt;p&gt;Bitmaps are suitable when:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The maximum number of states is known&lt;/li&gt;
&lt;li&gt;Indices are controlled and not arbitrary user input&lt;/li&gt;
&lt;li&gt;Logic is stable and unlikely to change&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;They are unsuitable when:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Keys are addresses or hashes&lt;/li&gt;
&lt;li&gt;State count is unbounded&lt;/li&gt;
&lt;li&gt;Readability and flexibility are critical&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A useful heuristic:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;If you need documentation just to explain what each bit means, complexity has already increased significantly.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;93-compact-encoding-and-slot-saving-thinking&#34;&gt;9.3 Compact Encoding and “Slot-Saving” Thinking
&lt;/h3&gt;&lt;p&gt;Some projects go further by:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Packing multiple fields into a single &lt;code&gt;uint256&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Using bit shifts and masks manually&lt;/li&gt;
&lt;li&gt;Re-implementing storage packing logic&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; packed;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Where:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Upper 128 bits store balance&lt;/li&gt;
&lt;li&gt;Lower 128 bits store timestamp&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While this can reduce slot count, it also:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Requires bit manipulation on every access&lt;/li&gt;
&lt;li&gt;Increases risk of boundary bugs&lt;/li&gt;
&lt;li&gt;Makes auditing and debugging harder&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Such techniques are justified only when:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Data structures are extremely stable&lt;/li&gt;
&lt;li&gt;Access frequency is very high&lt;/li&gt;
&lt;li&gt;Slot count is confirmed as the main bottleneck&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;94-about-assembly&#34;&gt;9.4 About &lt;code&gt;assembly&lt;/code&gt;
&lt;/h3&gt;&lt;p&gt;Solidity allows inline &lt;code&gt;assembly&lt;/code&gt;, enabling direct EVM opcode usage:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Skipping compiler-generated overhead&lt;/li&gt;
&lt;li&gt;Achieving lower Gas in extreme cases&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But be cautious:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;No type checks&lt;/li&gt;
&lt;li&gt;No overflow protection&lt;/li&gt;
&lt;li&gt;Dramatically reduced readability&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In most business contracts, &lt;strong&gt;the risk outweighs the benefit&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;95-when-assembly-is-worth-using&#34;&gt;9.5 When &lt;code&gt;assembly&lt;/code&gt; Is Worth Using
&lt;/h3&gt;&lt;p&gt;Reasonable scenarios include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Extremely hot execution paths&lt;/li&gt;
&lt;li&gt;Low-level utility functions&lt;/li&gt;
&lt;li&gt;Logic that is stable and well-tested&lt;/li&gt;
&lt;li&gt;Teams with audit support and experience&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Avoid using assembly for:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Core business logic&lt;/li&gt;
&lt;li&gt;Permission or fund management&lt;/li&gt;
&lt;li&gt;Marginal Gas savings&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A conservative rule:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;If Gas is already within a reasonable range without assembly, do not use assembly.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;96-evaluating-the-real-gains-of-advanced-optimizations&#34;&gt;9.6 Evaluating the Real Gains of Advanced Optimizations
&lt;/h3&gt;&lt;p&gt;Advanced optimizations usually yield:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Tens to hundreds of Gas saved per call&lt;/li&gt;
&lt;li&gt;Meaningful impact only in high-frequency paths&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Before using them, you should already have:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Completed storage, interface, and loop optimizations&lt;/li&gt;
&lt;li&gt;Identified real bottlenecks&lt;/li&gt;
&lt;li&gt;Measured Gas with actual test data&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Otherwise, it is easy to fall into “optimization for its own sake.”&lt;/p&gt;
&lt;h2 id=&#34;10-how-to-verify-whether-an-optimization-is-effective&#34;&gt;10. How to Verify Whether an Optimization Is Effective
&lt;/h2&gt;&lt;p&gt;After discussing many techniques, a more important question emerges:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;How do you know an optimization is actually worth it?&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This section emphasizes a &lt;strong&gt;data-driven approach&lt;/strong&gt; rather than intuition.&lt;/p&gt;
&lt;h3 id=&#34;101-why-you-cannot-rely-on-intuition&#34;&gt;10.1 Why You Cannot Rely on Intuition
&lt;/h3&gt;&lt;p&gt;Gas cost does not always correlate with perceived code complexity:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Some complex refactors barely change Gas&lt;/li&gt;
&lt;li&gt;Some small changes save a lot&lt;/li&gt;
&lt;li&gt;Some optimizations matter only at scale&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Without measurement, it is easy to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Miss high-impact improvements&lt;/li&gt;
&lt;li&gt;Over-optimize low-impact areas&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Gas optimization must therefore be &lt;strong&gt;measured engineering&lt;/strong&gt;, not guesswork.&lt;/p&gt;
&lt;h3 id=&#34;102-what-makes-an-optimization-effective&#34;&gt;10.2 What Makes an Optimization “Effective”
&lt;/h3&gt;&lt;p&gt;An optimization should answer three questions:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;How much Gas does it save?&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;How frequently does this code path execute?&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;How much complexity or risk does it introduce?&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Only when savings justify complexity is the optimization worthwhile.&lt;/p&gt;
&lt;h3 id=&#34;103-basic-benchmarking-approach&#34;&gt;10.3 Basic Benchmarking Approach
&lt;/h3&gt;&lt;p&gt;The simplest and most reliable method is &lt;strong&gt;before/after comparison&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Same input&lt;/li&gt;
&lt;li&gt;Only one implementation change&lt;/li&gt;
&lt;li&gt;Compare &lt;code&gt;gas used&lt;/code&gt;, not transaction fees&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Original function A&lt;/li&gt;
&lt;li&gt;Optimized function A′&lt;/li&gt;
&lt;li&gt;Measure Gas under identical conditions&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;104-a-conceptual-comparison-example&#34;&gt;10.4 A Conceptual Comparison Example
&lt;/h3&gt;&lt;p&gt;Original:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;add&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata xs) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; xs.length; i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        total &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; xs[i];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Optimized:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;addOptimized&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt;[] calldata xs) &lt;span style=&#34;color:#66d9ef&#34;&gt;external&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; t &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; total;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; len &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; xs.length;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;; i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; len; ) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        t &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; xs[i];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;unchecked&lt;/span&gt; { i&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;; }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    total &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; t;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The real question is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;At &lt;code&gt;xs.length = 10&lt;/code&gt;, &lt;code&gt;100&lt;/code&gt;, &lt;code&gt;1000&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Do Gas curves diverge meaningfully?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;That divergence is what matters.&lt;/p&gt;
&lt;h3 id=&#34;105-focus-on-worst-case-not-just-averages&#34;&gt;10.5 Focus on Worst-Case, Not Just Averages
&lt;/h3&gt;&lt;p&gt;In smart contracts, worst-case behavior often matters more:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Insufficient Gas causes failure&lt;/li&gt;
&lt;li&gt;Users hit edge cases&lt;/li&gt;
&lt;li&gt;Batch and loop risks concentrate at extremes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Testing should therefore:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Use maximum allowed inputs&lt;/li&gt;
&lt;li&gt;Cover boundary conditions&lt;/li&gt;
&lt;li&gt;Check proximity to block or function Gas limits&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;106-tools-matter-less-than-methodology&#34;&gt;10.6 Tools Matter Less Than Methodology
&lt;/h3&gt;&lt;p&gt;Teams may use:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Hardhat&lt;/li&gt;
&lt;li&gt;Foundry&lt;/li&gt;
&lt;li&gt;Truffle&lt;/li&gt;
&lt;li&gt;Custom scripts&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The methodology is always the same:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Fix inputs&lt;/li&gt;
&lt;li&gt;Repeat tests&lt;/li&gt;
&lt;li&gt;Compare Gas usage&lt;/li&gt;
&lt;li&gt;Let data drive decisions&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;107-when-to-stop-optimizing&#34;&gt;10.7 When to Stop Optimizing
&lt;/h3&gt;&lt;p&gt;A frequently overlooked question is: &lt;strong&gt;when is enough enough?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Stop when:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Further savings are marginal&lt;/li&gt;
&lt;li&gt;Code complexity increases noticeably&lt;/li&gt;
&lt;li&gt;High-frequency and high-cost paths are already optimized&lt;/li&gt;
&lt;li&gt;Audit and maintenance costs outweigh benefits&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Gas optimization is a balance, not an endless pursuit.&lt;/p&gt;
&lt;h2 id=&#34;11-an-actionable-gas-optimization-checklist&#34;&gt;11. An Actionable Gas Optimization Checklist
&lt;/h2&gt;&lt;p&gt;After systematically covering Gas optimization principles, we can now condense them into a &lt;strong&gt;practical checklist&lt;/strong&gt; for daily development and code reviews.&lt;/p&gt;
&lt;p&gt;This is not a rigid rulebook, but a &lt;strong&gt;priority-driven review order&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;111-design-phase-checks&#34;&gt;11.1 Design-Phase Checks
&lt;/h3&gt;&lt;p&gt;Before writing code, consider:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Is this state truly necessary, or derivable?&lt;/li&gt;
&lt;li&gt;Will the state be frequently accessed?&lt;/li&gt;
&lt;li&gt;Are there unbounded loops or batch interfaces?&lt;/li&gt;
&lt;li&gt;Does the data structure have a clear size limit?&lt;/li&gt;
&lt;li&gt;Are lookup, deduplication, or deletion required?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Many Gas issues can be avoided at this stage.&lt;/p&gt;
&lt;h3 id=&#34;112-storage-checks-highest-priority&#34;&gt;11.2 Storage Checks (Highest Priority)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Are storage variables read multiple times in one function?&lt;/li&gt;
&lt;li&gt;Is storage written inside loops?&lt;/li&gt;
&lt;li&gt;Can caching reduce &lt;code&gt;SLOAD&lt;/code&gt; / &lt;code&gt;SSTORE&lt;/code&gt;?&lt;/li&gt;
&lt;li&gt;Are variable and struct field orders optimized for packing?&lt;/li&gt;
&lt;li&gt;Is unused state deleted?&lt;/li&gt;
&lt;li&gt;Are mappings used instead of arrays for lookup and deduplication?&lt;/li&gt;
&lt;li&gt;If enumeration is needed, is mapping + array + index used with swap-and-pop?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is where optimization effort pays off the most.&lt;/p&gt;
&lt;h3 id=&#34;113-function-interface-and-parameter-checks&#34;&gt;11.3 Function Interface and Parameter Checks
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Are external interfaces marked &lt;code&gt;external&lt;/code&gt;?&lt;/li&gt;
&lt;li&gt;Do external functions use &lt;code&gt;calldata&lt;/code&gt;?&lt;/li&gt;
&lt;li&gt;Are unnecessary &lt;code&gt;public&lt;/code&gt; functions avoided?&lt;/li&gt;
&lt;li&gt;Are &lt;code&gt;this&lt;/code&gt; calls avoided?&lt;/li&gt;
&lt;li&gt;Is the external-entry + internal-implementation pattern used?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These optimizations are low-risk and consistently effective.&lt;/p&gt;
&lt;h3 id=&#34;114-loop-and-batch-checks&#34;&gt;11.4 Loop and Batch Checks
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Are array lengths and intermediate values cached?&lt;/li&gt;
&lt;li&gt;Is storage avoided inside loops?&lt;/li&gt;
&lt;li&gt;Are O(n) lookups avoided in loops?&lt;/li&gt;
&lt;li&gt;Is &lt;code&gt;unchecked&lt;/code&gt; used safely where applicable?&lt;/li&gt;
&lt;li&gt;Are loop bounds explicit?&lt;/li&gt;
&lt;li&gt;Do batch interfaces limit per-call size?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Loops amplify Gas—always review them from a worst-case perspective.&lt;/p&gt;
&lt;h3 id=&#34;115-error-handling-and-bytecode-size&#34;&gt;11.5 Error Handling and Bytecode Size
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Are custom errors used instead of &lt;code&gt;require(string)&lt;/code&gt;?&lt;/li&gt;
&lt;li&gt;Are error identifiers concise and structured?&lt;/li&gt;
&lt;li&gt;Are long strings avoided in bytecode?&lt;/li&gt;
&lt;li&gt;Is contract size close to deployment limits?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These optimizations become more valuable as contracts grow.&lt;/p&gt;
&lt;h3 id=&#34;116-events-and-return-values&#34;&gt;11.6 Events and Return Values
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Do events only log essential information?&lt;/li&gt;
&lt;li&gt;Are &lt;code&gt;indexed&lt;/code&gt; fields used only for frequent filters?&lt;/li&gt;
&lt;li&gt;Are large arrays or strings avoided in events?&lt;/li&gt;
&lt;li&gt;Are large on-chain return values avoided?&lt;/li&gt;
&lt;li&gt;Are pagination or off-chain indexing used instead?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The goal: &lt;strong&gt;do not treat the chain as a database.&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;117-advanced-optimizations-use-sparingly&#34;&gt;11.7 Advanced Optimizations (Use Sparingly)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Are foundational optimizations already complete?&lt;/li&gt;
&lt;li&gt;Is the bottleneck clearly identified?&lt;/li&gt;
&lt;li&gt;Do bitmaps or packing actually reduce slot usage?&lt;/li&gt;
&lt;li&gt;Is assembly avoided in core business logic?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Advanced optimizations should be &lt;strong&gt;data-backed exceptions&lt;/strong&gt;, not defaults.&lt;/p&gt;
&lt;h3 id=&#34;118-let-data-drive-final-decisions&#34;&gt;11.8 Let Data Drive Final Decisions
&lt;/h3&gt;&lt;p&gt;Before merging any optimization:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Is there clear Gas comparison data?&lt;/li&gt;
&lt;li&gt;Is the optimized path high-frequency or critical?&lt;/li&gt;
&lt;li&gt;Is the added complexity testable and auditable?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If the benefit cannot be clearly explained, the optimization is probably unnecessary.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>A Deep Understanding of the Fundamental Principles of Uniswap’s Concentrated Liquidity</title>
        <link>https://yearsuns-github-io.vercel.app/en/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/</link>
        <pubDate>Sat, 02 Aug 2025 14:59:56 +0800</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/</guid>
        <description>&lt;p&gt;If you know about Uniswap V2, you definitely know that its biggest advantage is “fully automated,” and its biggest problem is also “fully automated.” Once funds enter, they are mechanically distributed across the entire price range from 0 to ∞.&lt;/p&gt;
&lt;p&gt;This is supposed to be fair, but extremely inefficient:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Most of the time, assets are “sleeping” far away from the current market price, nobody trades there, and no fees are generated.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Therefore, Uniswap V3 proposed a revolutionary concept: Concentrated Liquidity.&lt;/p&gt;
&lt;p&gt;It allows LPs to “concentrate” capital within the price range they consider appropriate so that “active money actually works.”&lt;/p&gt;
&lt;h2 id=&#34;i-what-is-concentrated-liquidity-background-and-the-problem-it-solves&#34;&gt;&lt;strong&gt;I. What is Concentrated Liquidity: Background and the Problem It Solves&lt;/strong&gt;
&lt;/h2&gt;&lt;p&gt;The decentralized trading protocol Uniswap uses the automated market maker (AMM) model. Users don’t need to place orders or find counterparties — simply deposit two tokens into a pool to become a liquidity provider. This model is very simple, but it also brings an unnoticed problem: most liquidity does not actually work.&lt;/p&gt;
&lt;p&gt;To illustrate this, we need to review the mechanism of Uniswap v2.&lt;/p&gt;
&lt;h3 id=&#34;1-traditional-amm-constant-product-and-full-price-range&#34;&gt;&lt;strong&gt;1. Traditional AMM: Constant Product and “Full Price Range”&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;In v2’s constant product model, a trading pool maintains a formula:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;x · y = k&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Here, x and y are the quantities of two assets in the pool, and k is a constant. No matter how the price fluctuates, this formula always holds.&lt;/p&gt;
&lt;p&gt;But the model implicitly assumes:&lt;br&gt;
&lt;strong&gt;The liquidity of the pool is distributed across the entire price range from 0 to ∞.&lt;/strong&gt;&lt;br&gt;
Theoretically, no matter how high or low the price goes, the pool is “ready” to provide liquidity.&lt;/p&gt;
&lt;p&gt;The problem: &lt;strong&gt;real prices never go to 0 or infinity&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;In other words, liquidity is passively spread across a ridiculously wide range that will almost never be used.&lt;/p&gt;
&lt;h3 id=&#34;2-liquidity-utilization-problems&#34;&gt;&lt;strong&gt;2. Liquidity Utilization Problems&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Distributing liquidity across an overly wide range results in a very direct consequence:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Most capital is sleeping.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In reality, prices tend to fluctuate within a narrow band, so only funds inside that range actually participate in trades. Other funds are just lying around, consuming capital efficiency.&lt;/p&gt;
&lt;p&gt;This leads to two impacts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;For traders, active depth is limited, causing higher slippage&lt;/li&gt;
&lt;li&gt;For LPs, although much capital is locked, the return is not proportional&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In other words:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Capital utilization is low.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;3-why-concentrated-liquidity-is-needed&#34;&gt;&lt;strong&gt;3. Why Concentrated Liquidity Is Needed&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Uniswap v3 introduces Concentrated Liquidity, with the following core idea:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Liquidity should be placed where actual trading happens.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;If the price stays in a certain region for a long time, LPs can concentrate liquidity in that region instead of wasting it on extreme prices that might never occur.&lt;/p&gt;
&lt;p&gt;The effects are significant:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The same capital provides deeper liquidity&lt;/li&gt;
&lt;li&gt;Price impact for large orders is reduced&lt;/li&gt;
&lt;li&gt;Fee revenue increases&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This essentially changes the AMM from “broad distribution” to “locally effective distribution.”&lt;/p&gt;
&lt;h3 id=&#34;4-definition-of-concentrated-liquidity&#34;&gt;&lt;strong&gt;4. Definition of Concentrated Liquidity&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Strictly speaking, Concentrated Liquidity means:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;LPs only provide liquidity within a self-defined price range \([P_{lower}, P_{upper}]\). Once price moves outside the range, the LP stops participating and stops earning fees.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;That means each LP is no longer just part of a pool, but becomes a “conditional liquidity position.”&lt;/p&gt;
&lt;p&gt;From the contract’s perspective, the large pool is divided into many segments, and liquidity is placed into each range. Whichever range trades happen within, LPs of that segment earn fees.&lt;/p&gt;
&lt;h3 id=&#34;5-what-problem-does-it-actually-solve&#34;&gt;&lt;strong&gt;5. What Problem Does It Actually Solve&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;In one sentence:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Use the same capital to obtain deeper effective liquidity.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;But specifically, it improves three things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Capital Efficiency&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Lower Slippage&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Higher Fee Yield&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;These all come from one fact: liquidity can finally be concentrated rather than being infinitely diluted.&lt;/p&gt;
&lt;h3 id=&#34;6-but-its-not-a-free-optimization&#34;&gt;&lt;strong&gt;6. But It’s Not a Free Optimization&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Concentrated liquidity does not change the basic AMM logic but introduces a new dimension: &lt;strong&gt;price range&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This makes the LP role more strategic, similar to predicting price movement. Therefore, it also introduces a new risk:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If price moves out of the chosen range, the position becomes single-sided and stops earning.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To earn more, LPs must take on more management and judgement — a typical risk-return tradeoff.&lt;/p&gt;
&lt;h2 id=&#34;ii-how-concentrated-liquidity-works&#34;&gt;&lt;strong&gt;II. How Concentrated Liquidity Works&lt;/strong&gt;
&lt;/h2&gt;&lt;h3 id=&#34;1-inputs-required-to-provide-liquidity&#34;&gt;&lt;strong&gt;1. Inputs Required to Provide Liquidity&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Suppose we provide liquidity into an ETH/USDC pool, the contract requires:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Token pair: ETH / USDC&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Price range&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;lower price example: 2000 USDC/ETH&lt;/li&gt;
&lt;li&gt;upper price example: 3000 USDC/ETH&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Amount of ETH or USDC provided&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In other words, we’re telling the contract three things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I want to LP for ETH/USDC&lt;/li&gt;
&lt;li&gt;Within 2000–3000&lt;/li&gt;
&lt;li&gt;I’m willing to deposit this amount of tokens&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;2-which-tokens-must-be-deposited&#34;&gt;&lt;strong&gt;2. Which Token(s) Must Be Deposited&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Suppose current ETH/USDC price is 2500, then the system checks:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;
2000 &amp;lt; 2500 &amp;lt; 3000
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Meaning “price is inside the range.”&lt;/p&gt;
&lt;p&gt;This is extremely important because it determines which assets we need to provide:&lt;/p&gt;
&lt;h4 id=&#34;three-situations&#34;&gt;Three situations
&lt;/h4&gt;&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;Current Price&lt;/th&gt;
          &lt;th&gt;Required Deposit&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;Inside range&lt;/td&gt;
          &lt;td&gt;Provide both ETH and USDC&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;Below range&lt;/td&gt;
          &lt;td&gt;Only USDC&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;Above range&lt;/td&gt;
          &lt;td&gt;Only ETH&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Why? Not strategy — &lt;strong&gt;pure math&lt;/strong&gt;: AMM models automatically bias towards one asset depending on price.&lt;/p&gt;
&lt;p&gt;Simply put, scarcity determines demand. At low price, the pool needs more USDC; at high price, more ETH.&lt;/p&gt;
&lt;h3 id=&#34;3-understanding-liquidity-l&#34;&gt;&lt;strong&gt;3. Understanding Liquidity (L)&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Although we deposit ETH/USDC, the contract records a variable L (liquidity unit).&lt;/p&gt;
&lt;p&gt;Key points:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;We deposit assets&lt;/li&gt;
&lt;li&gt;Contract records L&lt;/li&gt;
&lt;li&gt;Earnings are proportional to L&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In short:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;L is our “position size” in that price range.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The amounts of ETH/USDC adjust automatically with price.&lt;/p&gt;
&lt;h3 id=&#34;4-price-range-discretization&#34;&gt;&lt;strong&gt;4. Price Range Discretization&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;We enter ranges in continuous price (e.g., 2000–3000), but internally the contract uses ticks.&lt;/p&gt;
&lt;p&gt;It converts them to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;\(tick_{Lower}\)&lt;/li&gt;
&lt;li&gt;\(tick_{Upper}\)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Ticks discretize price boundaries.&lt;/p&gt;
&lt;p&gt;The contract then stores only boundary updates:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;add +L at \(tick_{Lower}\)&lt;/li&gt;
&lt;li&gt;subtract –L at \(tick_{Upper}\)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Active liquidity at current price equals the sum of all netLiquidity values below the current tick.&lt;/p&gt;
&lt;p&gt;For example, if \(tick_{Lower}=100\) and \(tick_{Upper}=200\), the contract records:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;netLiquidity[100] += 10
netLiquidity[200] -= 10
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If the current price tick is 150, the activeLiquidity equals the sum of all netLiquidity where tick &amp;lt; 150, which is 10.&lt;/p&gt;
&lt;p&gt;If the current price tick is 205, then activeLiquidity equals the sum of all netLiquidity where tick &amp;lt; 205, which is 0.&lt;/p&gt;
&lt;p&gt;Therefore, when the price crosses these ticks, the system knows when to start and when to stop using our liquidity.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Why do we need to discretize price when storing ranges?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;If we simply used linear segmentation, such as slicing the 2000–3000 range into 1000 parts, each worth 1 USDC, it would seem natural.&lt;/p&gt;
&lt;p&gt;But what if the price range becomes 0.2–0.3 or even lower? If we still slice it into 1000 segments, each segment would become extremely small, and the overall scale would be highly uneven.&lt;/p&gt;
&lt;p&gt;Furthermore, real token prices can span multiple orders of magnitude, from 0.0000001 to 10,000,000, making uniform segmentation impossible.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;How do we perform discretization?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;We define that each tick corresponds to a price that is a fixed multiple \(r\) of the previous tick. Then, for \(tick+1\), the price \(P_{tick+1}\) satisfies:&lt;/p&gt;
\[
   P_{tick+1} = P_{tick} \times r
\]&lt;p&gt;From which we derive:&lt;/p&gt;
\[
   P_{tick} = P_0 \times r^{tick}
\]&lt;p&gt;If we set \(P_0 = 1\) and \(r=1.0001\), then:&lt;/p&gt;
\[
   P_{tick} = 1.0001^{tick}
\]&lt;p&gt;This means each tick movement corresponds to a 0.01% price change.&lt;/p&gt;
&lt;p&gt;Now we can represent any price using ticks:&lt;/p&gt;
\[
   tick = \log_{1.0001}(P)
\]&lt;p&gt;For example:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;\(P = 0.25\) corresponds to \(tick \approx -13864\)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;\(P = 2500\) corresponds to \(tick \approx 78244\)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Thus, we obtain a uniform tick scale that works for arbitrary token prices (as long as they’re not negative 🤪)&lt;/p&gt;
&lt;h3 id=&#34;5-storing-liquidity-state&#34;&gt;&lt;strong&gt;5. Storing Liquidity State&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;When we add liquidity, the system issues an NFT that records:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;chosen price range (2000–3000)&lt;/li&gt;
&lt;li&gt;size of L&lt;/li&gt;
&lt;li&gt;accumulated fees claimable&lt;/li&gt;
&lt;li&gt;current fee status required for future fee calculations&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Therefore:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The LP action is no longer part of the pool itself, but an independent position recorded as an NFT.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;6-position-changes&#34;&gt;&lt;strong&gt;6. Position Changes&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;When price is within the range:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;holds both ETH and USDC&lt;/li&gt;
&lt;li&gt;converts between the two as trades occur&lt;/li&gt;
&lt;li&gt;participates in matching and earns fees&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If price falls below &lt;strong&gt;2000&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;position becomes entirely USDC&lt;/li&gt;
&lt;li&gt;no longer provides liquidity or earns fees&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If price exceeds &lt;strong&gt;3000&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;position becomes entirely ETH&lt;/li&gt;
&lt;li&gt;also exits liquidity&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In other words:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When ETH rises, the position becomes ETH-heavy; when ETH falls, it becomes USDC-heavy.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This behavior is not a strategy — it is automatically done by the AMM logic.&lt;/p&gt;
&lt;h3 id=&#34;7-fee-settlement&#34;&gt;&lt;strong&gt;7. Fee Settlement&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;When trades occur inside the range (2500 is inside), fees accumulate. Internally, the contract records fees in the feeGrowth variable.&lt;/p&gt;
&lt;p&gt;When withdrawing, the contract does two things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;returns current holdings (could be ETH+USDC or single-token)&lt;/li&gt;
&lt;li&gt;returns accumulated fees&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;No need to manually claim—withdrawal automatically settles everything.&lt;/p&gt;
&lt;h2 id=&#34;iii-main-formula-derivations&#34;&gt;&lt;strong&gt;III. Main Formula Derivations&lt;/strong&gt;
&lt;/h2&gt;&lt;h3 id=&#34;1-official-whitepapers&#34;&gt;&lt;strong&gt;1. Official Whitepapers&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;v2: &lt;a class=&#34;link&#34; href=&#34;https://docs.uniswap.org/whitepaper.pdf&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://docs.uniswap.org/whitepaper.pdf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;v3: &lt;a class=&#34;link&#34; href=&#34;https://app.uniswap.org/whitepaper-v3.pdf&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://app.uniswap.org/whitepaper-v3.pdf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;v4: &lt;a class=&#34;link&#34; href=&#34;https://app.uniswap.org/whitepaper-v4.pdf&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://app.uniswap.org/whitepaper-v4.pdf&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;2-basic-formulas&#34;&gt;&lt;strong&gt;2. Basic Formulas&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Virtual reserve curve (trading model):&lt;/p&gt;
\[
   x \times y = k \tag{1}
\]&lt;p&gt;Liquidity:&lt;/p&gt;
\[
   L = \sqrt{xy} \tag{2}
\]&lt;p&gt;Price:&lt;/p&gt;
\[
   P = \frac{y}{x} \tag{3}
\]&lt;p&gt;Effective reserve curve:&lt;/p&gt;
\[
   (x+\dfrac{L}{\sqrt{p_{b}}})(y+L\sqrt{p_{a}})=L^{2} \tag{4}
\]&lt;h3 id=&#34;2-derivation-of-the-effective-reserve-curve&#34;&gt;&lt;strong&gt;2. Derivation of the Effective Reserve Curve&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;&lt;img src=&#34;https://yearsuns-github-io.vercel.app/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/virtual_reserves.png&#34;
	width=&#34;1880&#34;
	height=&#34;1466&#34;
	srcset=&#34;https://yearsuns-github-io.vercel.app/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/virtual_reserves_hu_7f2418a223292b52.png 480w, https://yearsuns-github-io.vercel.app/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/virtual_reserves_hu_577fb5efdb443dce.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;Figure 1 Virtual reserves&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;128&#34;
		data-flex-basis=&#34;307px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;As shown in Figure 1, the current price is at point c. Suppose the actual price movement range is \([a,b]\).&lt;/p&gt;
&lt;p&gt;When the price moves from c to a, the maximum pool consumption for token \(y\) is \(y_{real}\). Likewise, when price moves from c to b, the maximum pool consumption for token \(x\) is \(x_{real}\).&lt;/p&gt;
&lt;p&gt;Therefore, in theory, only \(x_{real}\) and \(y_{real}\) are required. All other funds are permanently unused, which also explains why the original xyk model has low capital efficiency.&lt;/p&gt;
&lt;p&gt;So the question is: what should the effective reserve curve actually look like?&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://yearsuns-github-io.vercel.app/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/effective_reserves.png&#34;
	width=&#34;720&#34;
	height=&#34;592&#34;
	srcset=&#34;https://yearsuns-github-io.vercel.app/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/effective_reserves_hu_7e45aaaa6c8583ea.png 480w, https://yearsuns-github-io.vercel.app/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-concentrated-liquidity/effective_reserves_hu_d0a3c978ce198002.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;Figure 2 Effective reserves&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;121&#34;
		data-flex-basis=&#34;291px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;As shown in Figure 2, we begin deriving the effective reserve curve.&lt;/p&gt;
&lt;p&gt;From the following formulas:&lt;/p&gt;
\[
   L^2 = xy \\
   P = \frac{y}{x}
\]&lt;p&gt;For anyone who has attended junior high school mathematics, multiplying and dividing both sides of the equations easily yields:&lt;/p&gt;
\[
\begin{aligned}
   x = \dfrac{L}{\sqrt{P}} \\
   y = L\sqrt{P} \tag{4}
\end{aligned}
\]&lt;p&gt;From Figure 1 we know:&lt;/p&gt;
\[
   x = x_{real} + x_b \\
   y = y_{real} + y_a
\]&lt;p&gt;Substituting into the xyk model (1):&lt;/p&gt;
\[
   (x_{real}+x_b)(y_{real}+y_a) = k = L^2
\]&lt;p&gt;Then substituting \(x_b, y_a\) using formula (4):&lt;/p&gt;
\[
   (x_{real}+\dfrac{L}{\sqrt{P_{b}}})(y_{real}+L\sqrt{P_{a}})=L^{2}
\]&lt;p&gt;This is the final formula of the effective reserve curve.&lt;/p&gt;
&lt;h3 id=&#34;3-calculating-liquidity-composition-changes&#34;&gt;&lt;strong&gt;3. Calculating Liquidity Composition Changes&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;After we provide liquidity, the contract starts performing trades. So how do we calculate the current allocation of assets inside our provided liquidity?&lt;/p&gt;
&lt;p&gt;Based on formula (4):&lt;/p&gt;
\[
\begin{aligned}
   x=\dfrac{L}{\sqrt{p}} \\
   y=L\sqrt{P} \tag{4}
\end{aligned}
\]&lt;p&gt;Let:&lt;/p&gt;
\[
\begin{aligned}
   S = \sqrt{P}
\end{aligned}
\]&lt;p&gt;Then:&lt;/p&gt;
\[
\begin{aligned}
   x = \dfrac{L}{S} \\
   y = L S
\end{aligned}
\]&lt;p&gt;Since L remains constant, differentiate with respect to S:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;For x:&lt;/strong&gt;&lt;/p&gt;
\[
x = \frac{L}{S}
\Rightarrow dx = -L \frac{1}{S^2} dS
\]&lt;p&gt;&lt;strong&gt;For y:&lt;/strong&gt;&lt;/p&gt;
\[
y = L S
\Rightarrow dy = L dS
\]&lt;p&gt;So we have two important differential relationships:&lt;/p&gt;
\[
dx = -L \frac{1}{S^2} dS,\qquad dy = L dS
\]&lt;p&gt;Suppose an LP’s effective price range is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Lower price: \(P_a\), corresponding to \(S_a = \sqrt{P_a}\)&lt;/li&gt;
&lt;li&gt;Upper price: \(P_b\), corresponding to \(S_b = \sqrt{P_b}\)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Consider only the \(token_y\) change&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Inside the range, when S increases from \(S_a\) to \(S_b\):&lt;/p&gt;
\[
dy = L dS
\]&lt;p&gt;Integrate S from \(S_a\) to \(S_b\):&lt;/p&gt;
\[
\Delta y = \int_{S_a}^{S_b} L\, dS
= L (S_b - S_a)
= L(\sqrt{P_b} - \sqrt{P_a})
\]&lt;p&gt;This is &lt;strong&gt;the total amount of \(token_y\) corresponding to the entire interval \([P_a, P_b]\)&lt;/strong&gt;:&lt;/p&gt;
\[
amount_y = L(\sqrt{P_b} - \sqrt{P_a})
\]&lt;p&gt;&lt;strong&gt;Consider only \(token_x\)&lt;/strong&gt;&lt;/p&gt;
\[
dx = -L \frac{1}{S^2} dS
\]&lt;p&gt;Note that x decreases as S increases (price rises → token_x decreases). We want the total amount in absolute value:&lt;/p&gt;
\[
\Delta x = \int_{S_a}^{S_b} L \frac{1}{S^2} dS
\]&lt;p&gt;Compute:&lt;/p&gt;
\[
\int \frac{1}{S^2} dS = -\frac{1}{S}
\]&lt;p&gt;Thus:&lt;/p&gt;
\[
\Delta x
= L\left[-\frac{1}{S}\right]_{S_a}^{S_b}
= L\left(-\frac{1}{S_b} + \frac{1}{S_a}\right)
= L\left(\frac{1}{S_a} - \frac{1}{S_b}\right)
\]&lt;p&gt;Substitute \(S = \sqrt{P}\):&lt;/p&gt;
\[
amount_x = L\left(\frac{1}{\sqrt{P_a}} - \frac{1}{\sqrt{P_b}}\right)
\]&lt;p&gt;This is the interval formula for \(token_x\).&lt;/p&gt;
&lt;p&gt;The above derivation covers total x/y in the entire interval \([P_a, P_b]\).
But the actual situation depends on where the current price lies:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Case A: Current price inside the range \((P_a &lt; P &lt; P_b)\)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The position holds “part token0 and part token1”:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;For \(token_x\), effective interval is [P, P_b]:&lt;/p&gt;
\[
  amount_x = L\left(\frac{1}{\sqrt{P}} - \frac{1}{\sqrt{P_b}}\right)
  \]&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;For \(token_y\), effective interval is [P_a, P]:&lt;/p&gt;
\[
  amount_y = L(\sqrt{P} - \sqrt{P_a})
  \]&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Case B: Price below the range \((P \le P_a)\)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The position has not “moved upward yet,” and is entirely in \(token_x\):&lt;/p&gt;
\[
amount_x = L\left(\frac{1}{\sqrt{P_a}} - \frac{1}{\sqrt{P_b}}\right) \\
amount_y = 0
\]&lt;p&gt;&lt;strong&gt;Case C: Price above the range \((P \ge P_b)\)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The position has “fully moved upward,” and is entirely \(token_y\):&lt;/p&gt;
\[
amount_x = 0 \\
amount_y = L(\sqrt{P_b} - \sqrt{P_a})
\]&lt;h3 id=&#34;4-calculating-the-actual-trading-price&#34;&gt;&lt;strong&gt;4. Calculating the Actual Trading Price&lt;/strong&gt;
&lt;/h3&gt;&lt;p&gt;Now that we understand the trading principle and core formulas, when preparing to swap tokens through the pool, the assets we input will also affect the ratio between pool assets. Since \(P=\dfrac{y}{x}\) is only a theoretical price, how do we calculate the actual execution price? For example, how many USDC can 1 ETH be swapped for?&lt;/p&gt;
&lt;p&gt;When we put \(\Delta x\) ETH into the pool, USDC in the pool decreases by \(\Delta y\), and the corresponding price moves from \(P_0\) down to \(P_1\). So we have:&lt;/p&gt;
\[
\begin{aligned}
\Delta x &amp;= L\left(\frac{1}{\sqrt{P_1}} - \frac{1}{\sqrt{P_0}}\right) = L\left(\frac{1}{S_1} - \frac{1}{S_0}\right) 
\Rightarrow 
S_1 = \frac{1}{\dfrac{\Delta x}{L} + \dfrac{1}{S_0}} \\
\Delta y &amp;= L(\sqrt{P_0} - \sqrt{P_1}) = L(S_0 - S_1) = 
L\left(S_0 - \frac{1}{\dfrac{\Delta x}{L} + \dfrac{1}{S_0}}\right)
\end{aligned}
\]&lt;p&gt;where L is the active liquidity in the current price segment.&lt;/p&gt;
&lt;p&gt;If the trade size is large and crosses multiple ticks, split the swap into segments and apply the same method for each interval, summing all the Δy values across each segment.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>A Deep Dive into the Fundamental Principles of Uniswap’s XYK Model</title>
        <link>https://yearsuns-github-io.vercel.app/en/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-xyk-model/</link>
        <pubDate>Wed, 16 Jul 2025 14:59:56 +0800</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/p/a-deep-dive-into-the-fundamental-principles-of-uniswaps-xyk-model/</guid>
        <description>&lt;blockquote&gt;
&lt;p&gt;XYK means: put a pair of assets into a “pool”, and require that the product of the two asset amounts always stays equal: &lt;code&gt;x * y = k&lt;/code&gt;.
All swaps must follow this rule, and therefore &lt;strong&gt;price, slippage, yield and risk&lt;/strong&gt; all naturally come from this formula.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Let’s walk through the math step by step.&lt;/p&gt;
&lt;h2 id=&#34;1-traditional-trading-why-do-we-need-an-order-book&#34;&gt;1. Traditional Trading: Why Do We Need an Order Book?
&lt;/h2&gt;&lt;p&gt;In traditional exchanges, the core mechanism is the &lt;strong&gt;order book&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A places a buy order at 100 for 1 ETH&lt;/li&gt;
&lt;li&gt;B places a sell order at 101 for 2 ETH&lt;/li&gt;
&lt;li&gt;The system matches orders and completes the trade&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This design has several characteristics:&lt;/p&gt;
&lt;h3 id=&#34;1-requires-professional-market-makers&#34;&gt;1. Requires professional market makers
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Without someone providing orders, ordinary traders cannot trade&lt;/li&gt;
&lt;li&gt;Market makers must watch the market and continuously update orders&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;2-requires-a-centralized-matching-engine&#34;&gt;2. Requires a centralized matching engine
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Run by the exchange&lt;/li&gt;
&lt;li&gt;You have to &lt;strong&gt;trust&lt;/strong&gt; the intermediary&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;3-ordinary-users-cannot-participate-in-market-making-easily&#34;&gt;3. Ordinary users cannot participate in market-making easily
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Hard to provide liquidity&lt;/li&gt;
&lt;li&gt;Most profits go to institutions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For blockchain, which emphasizes open participation, this is too centralized.&lt;/p&gt;
&lt;h2 id=&#34;2-amm-turning-market-making-into-a-liquidity-pool&#34;&gt;2. AMM: Turning Market Making into a Liquidity Pool
&lt;/h2&gt;&lt;p&gt;The innovation of AMM (Automated Market Maker) is transforming trading from order matching into a &lt;strong&gt;liquidity pool&lt;/strong&gt; that &lt;strong&gt;anyone&lt;/strong&gt; can join.&lt;/p&gt;
&lt;p&gt;A liquidity pool holds two assets (e.g., ETH and USDT) and follows:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;x * y = k
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This is the &lt;strong&gt;XYK constant product market maker model&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;When someone buys ETH with USDT, ETH decreases and USDT increases, while keeping the product constant.&lt;/p&gt;
&lt;p&gt;AMM replaces the order book:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;no buy/sell orders&lt;/li&gt;
&lt;li&gt;no professional market makers&lt;/li&gt;
&lt;li&gt;no centralized matching engine&lt;/li&gt;
&lt;li&gt;anyone can join&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So essentially:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AMM = liquidity pool + mathematical rule&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Price, slippage and liquidity depth all follow from this.&lt;/p&gt;
&lt;h2 id=&#34;3-how-is-price-determined&#34;&gt;3. How Is Price Determined?
&lt;/h2&gt;&lt;p&gt;Example:&lt;/p&gt;
&lt;p&gt;Pool state:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ETH &lt;code&gt;x = 100&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;USDT &lt;code&gt;y = 10000&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Then the price is naturally:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;price = y / x = 10000 / 100 = 100 USDT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Key points:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Price is not quoted manually&lt;/li&gt;
&lt;li&gt;Price changes automatically with pool state&lt;/li&gt;
&lt;li&gt;External arbitrage aligns the pool price to market price&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;So in AMM:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Price = asset ratio in pool&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;4-how-do-trades-change-price&#34;&gt;4. How Do Trades Change Price?
&lt;/h2&gt;&lt;h3 id=&#34;initial-state&#34;&gt;Initial State
&lt;/h3&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;x = 100 ETH
y = 10000 USDT
k = 1,000,000
P₀ = 100
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;A user wants to spend &lt;strong&gt;1000 USDT to buy ETH&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id=&#34;transaction-rule&#34;&gt;Transaction rule
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Must satisfy &lt;code&gt;x * y = k&lt;/code&gt; before and after the swap&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;after-the-swap&#34;&gt;After the swap
&lt;/h3&gt;&lt;p&gt;User adds:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Δy = +1000
y₂ = 11000
x₂ = 1,000,000 / 11000 ≈ 90.909
Δx ≈ 9.091
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Average price ≈ 110
Final price ≈ 121&lt;/p&gt;
&lt;p&gt;You observe:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Average paid ≈ 110&lt;/li&gt;
&lt;li&gt;Final price ≈ 121&lt;/li&gt;
&lt;li&gt;Initial price = 100&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;That feeling of:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“I buy → the price jumps!”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;That is &lt;strong&gt;slippage&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;5-slippage-not-a-fee-but-price-you-push-higher&#34;&gt;5. Slippage: Not a Fee, But Price You Push Higher
&lt;/h2&gt;&lt;p&gt;Slippage is not a fee:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;You moved the price by trading&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You are literally buying along the curve from cheap → expensive.
Bigger trades cause more slippage.&lt;/p&gt;
&lt;h2 id=&#34;6-why-bigger-pools-have-lower-slippage&#34;&gt;6. Why Bigger Pools Have Lower Slippage?
&lt;/h2&gt;&lt;p&gt;Compare:&lt;/p&gt;
&lt;h3 id=&#34;small-pool-100--10000&#34;&gt;Small pool: 100 / 10000
&lt;/h3&gt;&lt;p&gt;Price moves 100 → 121&lt;/p&gt;
&lt;h3 id=&#34;big-pool-1000--100000&#34;&gt;Big pool: 1000 / 100000
&lt;/h3&gt;&lt;p&gt;Price moves 100 → 102&lt;/p&gt;
&lt;p&gt;Conclusion:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;More liquidity → milder price curve → lower slippage&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It&amp;rsquo;s like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a basin vs. a lake&lt;/li&gt;
&lt;li&gt;adding a bucket changes the level much more in a basin&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;7-what-exactly-is-liquidity&#34;&gt;7. What Exactly Is Liquidity?
&lt;/h2&gt;&lt;p&gt;Liquidity = actual asset amounts in the pool&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;more liquidity → flatter curve → stable prices&lt;/li&gt;
&lt;li&gt;less liquidity → steep curve → price impact increases&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Anyone can provide liquidity, therefore:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Market-making becomes open&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;8-how-do-you-join-as-a-liquidity-provider&#34;&gt;8. How Do You Join as a Liquidity Provider?
&lt;/h2&gt;&lt;p&gt;Pool state:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;x = 100 ETH
y = 10000 USDT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Price = 100 USDT/ETH&lt;/p&gt;
&lt;p&gt;To add liquidity, you must deposit &lt;strong&gt;proportionally&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;add 1 ETH&lt;/li&gt;
&lt;li&gt;plus 100 USDT&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Otherwise you change the price.&lt;/p&gt;
&lt;p&gt;You receive &lt;strong&gt;LP tokens&lt;/strong&gt; representing your share.&lt;/p&gt;
&lt;p&gt;When you withdraw, you take &lt;strong&gt;a share of the pool&lt;/strong&gt;, not exactly what you put in.&lt;/p&gt;
&lt;p&gt;This is important for understanding impermanent loss.&lt;/p&gt;
&lt;h2 id=&#34;9-how-do-lps-earn-fees&#34;&gt;9. How Do LPs Earn Fees?
&lt;/h2&gt;&lt;p&gt;Each trade pays a small fee (e.g., 0.3%), and this fee:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;does NOT go to “the platform”&lt;/li&gt;
&lt;li&gt;goes into the pool&lt;/li&gt;
&lt;li&gt;distributed to LPs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Think of it as:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Traders use your assets, and you charge toll fees&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;LP earnings:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;trading fees&lt;/li&gt;
&lt;li&gt;token incentives&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;10-impermanent-loss&#34;&gt;10. Impermanent Loss
&lt;/h2&gt;&lt;p&gt;LPs earn fees but face impermanent loss.&lt;/p&gt;
&lt;p&gt;Example pool:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;1 ETH + 100 USDT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You add:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;1 ETH + 100 USDT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Pool:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2 ETH + 200 USDT
(You own 50%)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If ETH price falls, the pool becomes:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;4 ETH + 100 USDT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You withdraw:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2 ETH + 50 USDT = 100 USDT value
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You deposited value: 200
You withdraw value: 100&lt;/p&gt;
&lt;p&gt;You lose value because:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;pool moved toward the depreciating asset&lt;/li&gt;
&lt;li&gt;arbitrage takes the increasing asset out&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The pool automatically rebalances toward cheaper assets.&lt;/p&gt;
&lt;h2 id=&#34;11-what-problems-does-xyk-solve&#34;&gt;11. What Problems Does XYK Solve?
&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;No order book&lt;/li&gt;
&lt;li&gt;Price determined algorithmically&lt;/li&gt;
&lt;li&gt;Anyone can become a market maker&lt;/li&gt;
&lt;li&gt;Infrastructure becomes public and open&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;12-limitations--evolution&#34;&gt;12. Limitations &amp;amp; Evolution
&lt;/h2&gt;&lt;h3 id=&#34;xyk-drawbacks&#34;&gt;XYK drawbacks
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;Large slippage
→ specialized stable-swap curves (Curve)&lt;/li&gt;
&lt;li&gt;Poor capital efficiency
→ concentrated liquidity (Uniswap v3)&lt;/li&gt;
&lt;li&gt;Impermanent loss
→ LP bears volatility risk&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Still:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;XYK is the entrance door to AMM design&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Understanding XYK makes everything else easier.&lt;/p&gt;
&lt;h2 id=&#34;13-the-one-simple-formula&#34;&gt;13. The One Simple Formula
&lt;/h2&gt;&lt;p&gt;Back to:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;x * y = k
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;From this follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;price: &lt;code&gt;P = y / x&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;slippage&lt;/li&gt;
&lt;li&gt;liquidity depth&lt;/li&gt;
&lt;li&gt;LP revenue&lt;/li&gt;
&lt;li&gt;impermanent loss&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;XYK is the &lt;strong&gt;F = ma of DeFi&lt;/strong&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;deceptively simple, yet the foundation of decentralized trading.&lt;/p&gt;
&lt;/blockquote&gt;
</description>
        </item>
        <item>
        <title>How Passwords Should Be Safely Transmitted and Stored</title>
        <link>https://yearsuns-github-io.vercel.app/en/p/how-passwords-should-be-safely-transmitted-and-stored/</link>
        <pubDate>Sun, 29 Jun 2025 14:59:56 +0800</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/p/how-passwords-should-be-safely-transmitted-and-stored/</guid>
        <description>&lt;h2 id=&#34;1-introduction-passwords-are-the-last-line-of-defense-in-the-digital-world&#34;&gt;1. Introduction: Passwords Are the Last Line of Defense in the Digital World
&lt;/h2&gt;&lt;p&gt;In the entire ecosystem of internet security, passwords are the most common yet also the most fragile component.
Almost all services we use daily—email, online banking, social platforms, games, forums—rely on passwords to authenticate user identity.&lt;/p&gt;
&lt;p&gt;A password is essentially a &lt;strong&gt;weak credential&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It cannot prove who the user really is—it only proves that they “know a certain secret.”&lt;/li&gt;
&lt;li&gt;Once this secret is leaked, an attacker can completely impersonate you.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Modern cyberattacks are frequent and diverse. A single ordinary password leak often results in multiple accounts across different platforms being compromised.
To defend against these threats, we must strengthen both the &lt;strong&gt;transmission stage&lt;/strong&gt; and the &lt;strong&gt;storage stage&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This article builds from fundamental concepts and gradually develops a complete, modern password security system.&lt;/p&gt;
&lt;h2 id=&#34;2-why-are-passwords-so-dangerous&#34;&gt;2. Why Are Passwords So Dangerous?
&lt;/h2&gt;&lt;p&gt;At first glance, a password is just a string composed of characters.
But the damage caused by a leaked password is far more severe than it seems, mainly for two reasons.&lt;/p&gt;
&lt;h3 id=&#34;21-risk-1-leakage-during-transmission&#34;&gt;2.1 Risk 1: Leakage During Transmission
&lt;/h3&gt;&lt;p&gt;From the moment a user enters a password until it reaches the server, the data passes through:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The browser&lt;/li&gt;
&lt;li&gt;Local DNS resolution&lt;/li&gt;
&lt;li&gt;OS network stack&lt;/li&gt;
&lt;li&gt;Routers&lt;/li&gt;
&lt;li&gt;ISP backbone&lt;/li&gt;
&lt;li&gt;Server load balancers&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If &lt;strong&gt;any&lt;/strong&gt; part of this chain is compromised, the password could be intercepted.&lt;/p&gt;
&lt;p&gt;In theory, HTTPS solves the “eavesdropping problem.”
But reality is more complex. Common risks include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Malware installing fake root certificates (classic MITM strategy)&lt;/li&gt;
&lt;li&gt;Internal corporate/school networks performing TLS inspection&lt;/li&gt;
&lt;li&gt;Public Wi-Fi conducting ARP spoofing and re-signing HTTPS certificates&lt;/li&gt;
&lt;li&gt;Browser extensions injecting malicious scripts to read user input&lt;/li&gt;
&lt;li&gt;“Network optimization” software adding hidden interception modules&lt;/li&gt;
&lt;li&gt;Enterprise gateways performing SSL inspection (legal but unsafe)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In other words:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You cannot assume the user’s device or network environment is always secure.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Therefore, there is room to improve the security of transmission.&lt;/p&gt;
&lt;h3 id=&#34;22-risk-2-server-side-leakage&#34;&gt;2.2 Risk 2: Server-side Leakage
&lt;/h3&gt;&lt;p&gt;Most leaks occur on the server side. Common scenarios include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Database breaches (most common)&lt;/li&gt;
&lt;li&gt;Passwords accidentally printed in logs&lt;/li&gt;
&lt;li&gt;Developers outputting passwords during debugging&lt;/li&gt;
&lt;li&gt;Unencrypted backups mistakenly exposed to the public&lt;/li&gt;
&lt;li&gt;Third-party monitoring tools capturing sensitive fields&lt;/li&gt;
&lt;li&gt;Vulnerabilities (SQL injection, RCE) exposing the database&lt;/li&gt;
&lt;li&gt;Internal misuse of privileges by operations staff&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If the server stores &lt;strong&gt;plaintext passwords&lt;/strong&gt;, the consequences are catastrophic:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;All user passwords are exposed&lt;/li&gt;
&lt;li&gt;Accounts on other websites are compromised due to password reuse&lt;/li&gt;
&lt;li&gt;If attackers access a user’s email, the impact escalates further&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Therefore, the server must ensure that &lt;strong&gt;even if a breach occurs, attackers cannot obtain the real passwords&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;3-how-should-passwords-be-safely-transmitted-over-the-internet&#34;&gt;3. How Should Passwords Be Safely Transmitted Over the Internet?
&lt;/h2&gt;&lt;h3 id=&#34;31-the-most-straightforward-approach-send-the-password-directly-over-https&#34;&gt;3.1 The Most Straightforward Approach: Send the Password Directly Over HTTPS
&lt;/h3&gt;&lt;p&gt;This is the default method used by most websites today:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Browser ——HTTPS——&amp;gt; Server
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Advantages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Simple&lt;/li&gt;
&lt;li&gt;Mature&lt;/li&gt;
&lt;li&gt;Fast&lt;/li&gt;
&lt;li&gt;Compatible with everything&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The drawback is:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;It places all risk on the reliability of TLS.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;If TLS is compromised by a MITM attack, the password is exposed.&lt;/p&gt;
&lt;p&gt;Thus, some propose hashing the password &lt;strong&gt;on the client side first&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;4-front-end-hashing-risks-reduced-and-risks-not-reduced&#34;&gt;4. Front-end Hashing: Risks Reduced and Risks Not Reduced
&lt;/h2&gt;&lt;p&gt;The core idea of front-end hashing is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Even if the transmission is intercepted, the attacker does not get the real password.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Assume:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;P  = user password
H1 = hash(P)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The browser sends H1 instead of P.&lt;/p&gt;
&lt;h3 id=&#34;41-what-can-front-end-hashing-protect-against&#34;&gt;4.1 What Can Front-end Hashing Protect Against?
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Prevents MITM from obtaining the real password&lt;/li&gt;
&lt;li&gt;Prevents plaintext password leakage through server logs/monitoring&lt;/li&gt;
&lt;li&gt;Attackers cannot use H1 to log in to the user’s accounts on &lt;strong&gt;other&lt;/strong&gt; websites&lt;/li&gt;
&lt;li&gt;Even if users reuse passwords elsewhere, a breach of your site won’t cascade to others (very important)&lt;/li&gt;
&lt;li&gt;The server never touches plaintext passwords (a simple form of zero-knowledge authentication)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Front-end hashing provides:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“Even if your website is compromised, attackers still cannot learn users’ real passwords for other services.”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Traditional approaches cannot offer this.&lt;/p&gt;
&lt;h3 id=&#34;42-what-can-front-end-hashing-not-protect-against&#34;&gt;4.2 What Can Front-end Hashing &lt;em&gt;Not&lt;/em&gt; Protect Against?
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Attackers can directly use H1 to log in to &lt;strong&gt;your&lt;/strong&gt; website (you treat it as the credential)&lt;/li&gt;
&lt;li&gt;Keyloggers / infected devices still capture P&lt;/li&gt;
&lt;li&gt;Hashes without challenge are vulnerable to replay attacks&lt;/li&gt;
&lt;li&gt;HTTPS is still required—hashes themselves must be encrypted&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In short:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Front-end hashing reduces damage but does not eliminate risk.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;43-is-front-end-hashing-necessary&#34;&gt;4.3 Is Front-end Hashing Necessary?
&lt;/h3&gt;&lt;p&gt;In practice, it is an &lt;strong&gt;optional but clearly beneficial&lt;/strong&gt; enhancement.&lt;/p&gt;
&lt;p&gt;When implemented properly (with challenges to prevent replay), front-end hashing creates a dual defense:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;TLS ensures transport security&lt;/li&gt;
&lt;li&gt;Hashing reduces cross-site password reuse impact&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;High-security systems (banks, enterprise platforms, developer services) often use such mechanisms.&lt;/p&gt;
&lt;h2 id=&#34;5-how-should-servers-store-passwords&#34;&gt;5. How Should Servers Store Passwords?
&lt;/h2&gt;&lt;p&gt;Now to the core of password engineering:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Passwords must never appear in plaintext—even inside the server.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Industry standards involve three key elements:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Hash&lt;/li&gt;
&lt;li&gt;Salt&lt;/li&gt;
&lt;li&gt;Slow hash&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;51-hashing-making-it-irreversible&#34;&gt;5.1 Hashing: Making It Irreversible
&lt;/h3&gt;&lt;p&gt;A good hashing function must:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Have extremely low collision probability&lt;/li&gt;
&lt;li&gt;Change output drastically when input changes slightly (avalanche effect)&lt;/li&gt;
&lt;li&gt;Make it impossible to reverse the input&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Servers store:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;H = hash(P)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If the database leaks, attackers cannot directly obtain the password.&lt;/p&gt;
&lt;h3 id=&#34;52-salt-preventing-rainbow-tables-and-mass-cracking&#34;&gt;5.2 Salt: Preventing Rainbow Tables and Mass Cracking
&lt;/h3&gt;&lt;p&gt;Without salt, users with the same weak passwords produce identical hashes. Attackers can:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Use precomputed rainbow tables&lt;/li&gt;
&lt;li&gt;Test common passwords once to crack many accounts&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;By adding a random salt:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;H = hash(P + salt)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Two users with “123456” have completely different hashes&lt;/li&gt;
&lt;li&gt;Rainbow tables become useless&lt;/li&gt;
&lt;li&gt;Attackers must brute-force each user individually (massively increasing cost)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Salt must be:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Long enough (≥16 bytes)&lt;/li&gt;
&lt;li&gt;Random (CSPRNG)&lt;/li&gt;
&lt;li&gt;Unique per user&lt;/li&gt;
&lt;li&gt;Stored in plaintext (not encrypted)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;53-slow-hashing-truly-increasing-the-cost-of-attacks&#34;&gt;5.3 Slow Hashing: Truly Increasing the Cost of Attacks
&lt;/h3&gt;&lt;p&gt;Algorithms like SHA256 are far too fast.
Modern GPUs can compute billions of SHA256 hashes per second.&lt;/p&gt;
&lt;p&gt;Meaning:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Even with salt, SHA256-stored passwords can often be cracked quickly.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Thus, we must use slow hashing algorithms designed specifically for password storage:&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;Algorithm&lt;/th&gt;
          &lt;th&gt;Characteristics&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;bcrypt&lt;/strong&gt;&lt;/td&gt;
          &lt;td&gt;Classic, mature&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;scrypt&lt;/strong&gt;&lt;/td&gt;
          &lt;td&gt;GPU-resistant, high memory use&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;Argon2 (recommended)&lt;/strong&gt;&lt;/td&gt;
          &lt;td&gt;Winner of password hashing competition; tunable CPU/memory/parallelism&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Slow hashing is not about “stronger hashing”; it&amp;rsquo;s about:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Making each guess expensive so attackers cannot perform massive brute-force attacks.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Login delays are negligible:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Users log in infrequently&lt;/li&gt;
&lt;li&gt;Each slow-hash costs only tens of milliseconds&lt;/li&gt;
&lt;li&gt;Attackers cannot scale up computations the same way&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;6-dual-protection-front-end-hash--back-end-slow-hash&#34;&gt;6. Dual Protection: Front-end Hash + Back-end Slow Hash
&lt;/h2&gt;&lt;p&gt;Combined:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;P → H1 = hash1(P) → (transmission) → H2 = bcrypt(H1 + salt)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Dual-layer benefits:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MITM capturing H1 cannot use it on other sites&lt;/li&gt;
&lt;li&gt;Database leaks revealing H2 are still hard to crack&lt;/li&gt;
&lt;li&gt;Server never touches plaintext passwords&lt;/li&gt;
&lt;li&gt;Logs and monitoring systems cannot leak P&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This “front-end hash + back-end slow hash” model is used in high-security environments to reduce cascade risks.&lt;/p&gt;
&lt;h2 id=&#34;7-the-replay-attack-problem-of-front-end-hashing-and-its-solution&#34;&gt;7. The Replay Attack Problem of Front-end Hashing and Its Solution
&lt;/h2&gt;&lt;p&gt;If front-end hashing is simply:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;H1 = hash(P)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;An attacker who intercepts H1 can replay it indefinitely—almost identical to stealing the real password.&lt;/p&gt;
&lt;h3 id=&#34;solution-use-a-random-challenge&#34;&gt;Solution: Use a &lt;strong&gt;random challenge&lt;/strong&gt;.
&lt;/h3&gt;&lt;h3 id=&#34;71-complete-workflow&#34;&gt;7.1 Complete Workflow
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;User opens login page&lt;/strong&gt;
The server generates a challenge:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;challenge = random string
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Browser computes:&lt;/strong&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;H1 = hash(P + challenge)
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Server verifies:&lt;/strong&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;bcrypt(H1 + salt) == stored_hash
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;72-benefits&#34;&gt;7.2 Benefits
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;H1 is different every time (challenge varies)&lt;/li&gt;
&lt;li&gt;Intercepted H1 cannot be reused&lt;/li&gt;
&lt;li&gt;MITM value decreases&lt;/li&gt;
&lt;li&gt;Server does not need to store challenge—just verify once and discard&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;73-common-engineering-issues&#34;&gt;7.3 Common Engineering Issues
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Challenge must not be cached (use no-cache)&lt;/li&gt;
&lt;li&gt;Must be long enough (≥16 bytes)&lt;/li&gt;
&lt;li&gt;Front-end must use secure hash (SHA256 or higher)&lt;/li&gt;
&lt;li&gt;Still requires HTTPS (challenge itself can be intercepted otherwise)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;8-additional-important-practices-often-overlooked&#34;&gt;8. Additional Important Practices (Often Overlooked)
&lt;/h2&gt;&lt;h3 id=&#34;81-never-email-users-their-passwords&#34;&gt;8.1 Never Email Users Their Passwords
&lt;/h3&gt;&lt;p&gt;Sending a new password via email is extremely dangerous.
Correct process:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Send a password reset link&lt;/li&gt;
&lt;li&gt;Link contains a one-time token&lt;/li&gt;
&lt;li&gt;User must set a new password&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;82-do-not-allow-weak-passwords&#34;&gt;8.2 Do Not Allow Weak Passwords
&lt;/h3&gt;&lt;p&gt;Weak passwords are exponentially easier to crack:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;123456&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;password&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;qwerty&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;User phone numbers&lt;/li&gt;
&lt;li&gt;User birthdays&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Use:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Blacklists of common passwords (top 10k)&lt;/li&gt;
&lt;li&gt;Length policies (≥12 chars)&lt;/li&gt;
&lt;li&gt;Encouragement of password managers&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;83-multi-factor-authentication-mfa--2fa&#34;&gt;8.3 Multi-factor Authentication (MFA / 2FA)
&lt;/h3&gt;&lt;p&gt;Passwords are only the first layer.
A second factor dramatically reduces attack success rates:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TOTP (Google Authenticator)&lt;/li&gt;
&lt;li&gt;SMS codes (weaker, but still useful)&lt;/li&gt;
&lt;li&gt;Hardware keys (FIDO2 / U2F)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;84-account-protection-features&#34;&gt;8.4 Account Protection Features
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Lockouts after multiple failed attempts&lt;/li&gt;
&lt;li&gt;Suspicious-login email alerts&lt;/li&gt;
&lt;li&gt;Unusual IP/UA verification steps&lt;/li&gt;
&lt;li&gt;Recent login activity logs for user review&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;85-password-breach-checks-hibp-api&#34;&gt;8.5 Password Breach Checks (HIBP API)
&lt;/h3&gt;&lt;p&gt;Many large websites check whether:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A user&amp;rsquo;s chosen password appears in known breach databases (like HaveIBeenPwned)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This significantly reduces risk from weak password reuse.&lt;/p&gt;
&lt;h2 id=&#34;9-goals-of-a-modern-password-security-system&#34;&gt;9. Goals of a Modern Password Security System
&lt;/h2&gt;&lt;p&gt;With all steps combined, a modern password system should ensure:&lt;/p&gt;
&lt;h3 id=&#34;91-secure-transmission&#34;&gt;9.1 Secure Transmission
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Use HTTPS&lt;/li&gt;
&lt;li&gt;Optional front-end hashing to prevent cascading leaks&lt;/li&gt;
&lt;li&gt;Challenge-based anti-replay&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;92-secure-storage&#34;&gt;9.2 Secure Storage
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Never store plaintext passwords&lt;/li&gt;
&lt;li&gt;Unique salt per user&lt;/li&gt;
&lt;li&gt;Use slow hashing algorithms&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;93-account-protection&#34;&gt;9.3 Account Protection
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Strong password policies&lt;/li&gt;
&lt;li&gt;MFA&lt;/li&gt;
&lt;li&gt;Anomaly detection&lt;/li&gt;
&lt;li&gt;Password leak comparison&lt;/li&gt;
&lt;li&gt;No sensitive info in logs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The final objective:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Even if the entire server is compromised, attackers still cannot obtain any user&amp;rsquo;s real password.&lt;/p&gt;
&lt;/blockquote&gt;
</description>
        </item>
        <item>
        <title>Archives</title>
        <link>https://yearsuns-github-io.vercel.app/en/archives/</link>
        <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/archives/</guid>
        <description></description>
        </item>
        <item>
        <title>Search</title>
        <link>https://yearsuns-github-io.vercel.app/en/search/</link>
        <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/search/</guid>
        <description></description>
        </item>
        <item>
        <title>关于站长</title>
        <link>https://yearsuns-github-io.vercel.app/en/about/</link>
        <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
        
        <guid>https://yearsuns-github-io.vercel.app/en/about/</guid>
        <description>&lt;h3 id=&#34;站长是谁&#34;&gt;站长是谁？
&lt;/h3&gt;&lt;p&gt;江湖人称王离谱，IT界的气氛组，离谱界的扛把子，沙雕界的主心骨。&lt;br&gt;
曾是全职二手码农，因&lt;strong&gt;不善加班&lt;/strong&gt;，拒绝ICU套餐，失足落入自由职业，活比牛马多，活得比牛马累。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;荣誉头衔&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;2006年美国时代周刊年度风云人物&lt;/li&gt;
&lt;li&gt;《感动中国》2008年度人物特别奖&lt;/li&gt;
&lt;li&gt;联合国2019年度”地球卫士“联合获奖人&lt;/li&gt;
&lt;li&gt;2022年奥林匹克杯获得者&lt;/li&gt;
&lt;li&gt;诺贝尔文学奖读者&lt;/li&gt;
&lt;li&gt;清华大学所在国学生&lt;/li&gt;
&lt;li&gt;世界500强企业简历投递者&lt;/li&gt;
&lt;li&gt;共和国马后炮炮手荣誉勋章获得者&lt;/li&gt;
&lt;li&gt;国家沙雕艺术非物质文化传承人&lt;/li&gt;
&lt;li&gt;国家特级退堂鼓表演艺术家&lt;/li&gt;
&lt;li&gt;国家特级唱反调表演艺术家&lt;/li&gt;
&lt;li&gt;国家一级抬杠运动员&lt;/li&gt;
&lt;li&gt;国家一级擦边球教练&lt;/li&gt;
&lt;li&gt;国家一级奶茶品鉴师&lt;/li&gt;
&lt;li&gt;临时抱佛脚协会会长&lt;/li&gt;
&lt;li&gt;中国驰名双标工程总负责人&lt;/li&gt;
&lt;li&gt;白日梦全球总冠军&lt;/li&gt;
&lt;li&gt;美图秀秀特约造型师&lt;/li&gt;
&lt;li&gt;闭门羹特级烹饪师&lt;/li&gt;
&lt;li&gt;墙头草栽培专家&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;建站的初衷&#34;&gt;建站的初衷
&lt;/h3&gt;&lt;p&gt;这个小破站的使命有三：&lt;strong&gt;分享知识、分享见解、分享生活&lt;/strong&gt;。&lt;br&gt;
信奉“助人者，人恒助之”，希望这个地方不仅能帮到别人，也能遇见更多志同道合的朋友，一起搞钱、共同逐梦，让梦想照进现实，而不是继续躺在购物车里。&lt;/p&gt;
&lt;h3 id=&#34;未来的计划&#34;&gt;未来的计划
&lt;/h3&gt;&lt;p&gt;紧跟AI浪潮，&lt;strong&gt;搞更多的钱，帮更多的人，装更多的X&lt;/strong&gt;。&lt;/p&gt;
&lt;h3 id=&#34;一句想说的话&#34;&gt;一句想说的话
&lt;/h3&gt;&lt;p&gt;睁眼观世界，闭眼世界观。&lt;/p&gt;
&lt;h3 id=&#34;请站长喝杯咖啡&#34;&gt;请站长喝杯咖啡
&lt;/h3&gt;&lt;p&gt;☕ 要么让咖啡燃起我的灵感，👻要么让香火点燃我的灵堂！&lt;br&gt;
&lt;img src=&#34;https://yearsuns-github-io.vercel.app/about/wechat_payment.png&#34;
	width=&#34;261&#34;
	height=&#34;256&#34;
	srcset=&#34;https://yearsuns-github-io.vercel.app/about/wechat_payment_hu_7110ac74c750e57.png 480w, https://yearsuns-github-io.vercel.app/about/wechat_payment_hu_2b8d77efea6a55db.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;微信扫码&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;101&#34;
		data-flex-basis=&#34;244px&#34;
	
&gt;&lt;/p&gt;
&lt;h3 id=&#34;联系站长&#34;&gt;联系站长
&lt;/h3&gt;&lt;p&gt;请老爷用大大的红包🧧来羞辱我吧！&lt;br&gt;
&lt;img src=&#34;https://yearsuns-github-io.vercel.app/about/wechat_qr_code.png&#34;
	width=&#34;256&#34;
	height=&#34;256&#34;
	srcset=&#34;https://yearsuns-github-io.vercel.app/about/wechat_qr_code_hu_22b9b81a6e95acf2.png 480w, https://yearsuns-github-io.vercel.app/about/wechat_qr_code_hu_73fe7de4344e69f.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;微信扫码&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;100&#34;
		data-flex-basis=&#34;240px&#34;
	
&gt;&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
